---
title: "LIT-DIA_complete"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    highlight: kate
    fig_width: 9
    fig_height : 7
    df_print: paged
    number_sections: true
    fig_crop: no
---

```{r, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Load packages

```{r}
library("tidyverse")
library("UpSetR")
library("patchwork")
library("ggpubr")
library("ggpointdensity")
library("kableExtra")
library("ggupset")
library("pheatmap")
library("robustbase")
library("fmsb")
library("ggrepel")

#set bw theme as default theme
theme_set(theme_bw())

teera_palette <- c("#EEB9CF","#DF7FA7","#D35087","#EAACC6",
                   "#C9D7F0","#7F9FDB","#527DCE","#ADC2E8")
```

# Upset plot analysis

## Load files

```{r, echo = FALSE}
lit_path <- 
  "C://Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/LIT/"
ot_path <- 
  "C://Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/OT/"
pp_path <- 
  "C://Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/points_across_a_peak/"
fig_path <- 
  "C://Users/samgr/OneDrive - UCL/Documents/Internship/Figure/"
  
```


```{r}
DDA_1 <- read_tsv(paste0(lit_path, "DDA_1ng.txt"))
DDA_5 <- read_tsv(paste0(lit_path, "DDA_5ng.txt"))
DDA_10 <- read_tsv(paste0(lit_path, "DDA_10ng.txt"))
DDA_100 <- read_tsv(paste0(lit_path, "DDA_100ng.txt"))

DIA_1 <- 
  read.csv2(paste0(lit_path,       "20220420_LIT_Turbo_DIA_1ng_40SPD_whisper100_1CV_8ms.csv"))
DIA_5 <- 
  read.csv2(paste0(lit_path, "20220420_LIT_Turbo_DIA_5ng_40SPD_whisper100_1CV_8ms.csv"))
DIA_10 <- 
  read.csv2(paste0(lit_path, "20220420_LIT_Turbo_DIA_10ng_40SPD_whisper100_1CV_8ms.csv"))
DIA_100 <- 
  read.csv2(paste0(lit_path, "20220420_LIT_Turbo_DIA_100ng_40SPD_whisper100_1CV_8ms.csv"))

```

## Filtering

### Filter potential contaminants and reverse

DDA 1ng
```{r}
dim(DDA_1)[1]
temp <- DDA_1 %>% 
  filter(is.na(DDA_1$Reverse))
DDA_1 <- temp %>% filter(is.na(temp$`Potential contaminant`))
dim(DDA_1)[1]
```

DDA 5ng
```{r}
dim(DDA_5)[1]
temp <- DDA_5 %>% 
  filter(is.na(DDA_5$Reverse))
DDA_5 <- temp %>% filter(is.na(temp$`Potential contaminant`))
dim(DDA_5)[1]
```

DDA 10ng
```{r}
dim(DDA_10)[1]
temp <- DDA_10 %>% 
  filter(is.na(DDA_10$Reverse))
DDA_10 <- temp %>% filter(is.na(temp$`Potential contaminant`))
dim(DDA_10)[1]
```

DDA 100ng
```{r}
dim(DDA_100)[1]
temp <- DDA_100 %>% 
  filter(is.na(DDA_100$Reverse))
DDA_100 <- temp %>% filter(is.na(temp$`Potential contaminant`))
dim(DDA_100)[1]
```

### Keep peptides found in 2 of the 4 replicates

#### Extract peptide sequences found in specific replicate


DDA 1ng
```{r}
table(DDA_1$`Raw file`)

DDA_1_1_pep <- DDA_1 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_1ng_Turbo_1CV_8ms_S01") %>% 
  pull(Sequence)

DDA_1_2_pep <- DDA_1 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_1ng_Turbo_1CV_8ms_S02") %>% 
  pull(Sequence)

DDA_1_3_pep <- DDA_1 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_1ng_Turbo_1CV_8ms_S03") %>% 
  pull(Sequence)

DDA_1_4_pep <- DDA_1 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_1ng_Turbo_1CV_8ms_S04") %>% 
  pull(Sequence)
```


DDA 5ng
```{r}
table(DDA_5$`Raw file`)

DDA_5_1_pep <- DDA_5 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_5ng_Turbo_1CV_8ms_S01") %>% 
  pull(Sequence)

DDA_5_2_pep <- DDA_5 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_5ng_Turbo_1CV_8ms_S02") %>% 
  pull(Sequence)

DDA_5_3_pep <- DDA_5 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_5ng_Turbo_1CV_8ms_S03") %>% 
  pull(Sequence)

DDA_5_4_pep <- DDA_5 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_5ng_Turbo_1CV_8ms_S04") %>% 
  pull(Sequence)
```


DDA 10ng
```{r}
table(DDA_10$`Raw file`)

DDA_10_1_pep <- DDA_10 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_10ng_Turbo_1CV_8ms_S01") %>% 
  pull(Sequence)

DDA_10_2_pep <- DDA_10 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_10ng_Turbo_1CV_8ms_S02") %>% 
  pull(Sequence)

DDA_10_3_pep <- DDA_10 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_10ng_Turbo_1CV_8ms_S03") %>% 
  pull(Sequence)

DDA_10_4_pep <- DDA_10 %>% 
  filter(`Raw file` ==
           "20220414_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_10ng_Turbo_1CV_8ms_S04") %>% 
  pull(Sequence)
```


DDA 100ng
```{r}
table(DDA_100$`Raw file`)

DDA_100_1_pep <- DDA_100 %>% 
  filter(`Raw file` ==
           "20220413_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_100ng_Turbo_1CV_8ms_S01") %>% 
  pull(Sequence)

DDA_100_2_pep <- DDA_100 %>% 
  filter(`Raw file` ==
           "20220413_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_100ng_Turbo_1CV_8ms_S02") %>% 
  pull(Sequence)

DDA_100_3_pep <- DDA_100 %>% 
  filter(`Raw file` ==
           "20220413_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_100ng_Turbo_1CV_8ms_S03") %>% 
  pull(Sequence)

DDA_100_4_pep <- DDA_100 %>% 
  filter(`Raw file` ==
           "20220413_HB_Evo_Whisper100_40SPD_LITDDA_HeLa_100ng_Turbo_1CV_8ms_S04") %>% 
  pull(Sequence)
```

DIA 1ng
```{r}
DIA_1 <- DIA_1 %>% 
  filter(EG.IsImputed == "False")

table(DIA_1$R.FileName)

DIA_1_1_pep <- DIA_1 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_1ng_1CV45_LITDIA_Turbo_8ms_s01") %>% 
  pull(PEP.StrippedSequence)

DIA_1_2_pep <- DIA_1 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_1ng_1CV45_LITDIA_Turbo_8ms_s02") %>% 
  pull(PEP.StrippedSequence)

DIA_1_3_pep <- DIA_1 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_1ng_1CV45_LITDIA_Turbo_8ms_s03") %>% 
  pull(PEP.StrippedSequence)

DIA_1_4_pep <- DIA_1 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_1ng_1CV45_LITDIA_Turbo_8ms_s04") %>% 
  pull(PEP.StrippedSequence)
```


DIA 5ng
```{r}
DIA_5 <- DIA_5 %>% 
  filter(EG.IsImputed == "False")

table(DIA_5$R.FileName)

DIA_5_1_pep <- DIA_5 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_5ng_1CV45_LITDIA_Turbo_8ms_s01") %>% 
  pull(PEP.StrippedSequence)

DIA_5_2_pep <- DIA_5 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_5ng_1CV45_LITDIA_Turbo_8ms_s02") %>% 
  pull(PEP.StrippedSequence)

DIA_5_3_pep <- DIA_5 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_5ng_1CV45_LITDIA_Turbo_8ms_s03") %>% 
  pull(PEP.StrippedSequence)

DIA_5_4_pep <- DIA_5 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_5ng_1CV45_LITDIA_Turbo_8ms_s04") %>% 
  pull(PEP.StrippedSequence)
```

DIA 10ng
```{r}

DIA_10 <- DIA_10 %>% 
  filter(EG.IsImputed == "False")

table(DIA_10$R.FileName)

DIA_10_1_pep <- DIA_10 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_10ng_1CV45_LITDIA_Turbo_8ms_s01") %>% 
  pull(PEP.StrippedSequence)

DIA_10_2_pep <- DIA_10 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_10ng_1CV45_LITDIA_Turbo_8ms_s02") %>% 
  pull(PEP.StrippedSequence)

DIA_10_3_pep <- DIA_10 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_10ng_1CV45_LITDIA_Turbo_8ms_s03") %>% 
  pull(PEP.StrippedSequence)

DIA_10_4_pep <- DIA_10 %>% 
  filter(R.FileName ==
           "20220221_EV_Evo_Whisper100_40SPD_HeLa_10ng_1CV45_LITDIA_Turbo_8ms_s04") %>% 
  pull(PEP.StrippedSequence)
```

DIA 100ng
```{r}
DIA_100 <- DIA_100 %>% 
  filter(EG.IsImputed == "False")

table(DIA_100$R.FileName)

DIA_100_1_pep <- DIA_100 %>% 
  filter(R.FileName ==
           "20220412_HB_Evo_Whisper100_40SPD_LITDIA_HeLa_100ng_Turbo_1CV_8ms_S01") %>% 
  pull(PEP.StrippedSequence)

DIA_100_2_pep <- DIA_100 %>% 
  filter(R.FileName ==
           "20220412_HB_Evo_Whisper100_40SPD_LITDIA_HeLa_100ng_Turbo_1CV_8ms_S02") %>% 
  pull(PEP.StrippedSequence)

DIA_100_3_pep <- DIA_100 %>% 
  filter(R.FileName ==
           "20220412_HB_Evo_Whisper100_40SPD_LITDIA_HeLa_100ng_Turbo_1CV_8ms_S03") %>% 
  pull(PEP.StrippedSequence)

DIA_100_4_pep <- DIA_100 %>% 
  filter(R.FileName ==
           "20220412_HB_Evo_Whisper100_40SPD_LITDIA_HeLa_100ng_Turbo_1CV_8ms_S04") %>% 
  pull(PEP.StrippedSequence)
```

#### Remove peptides found in in less than 3 replicates

DDA 1ng
```{r}
DDA_1 <- DDA_1 %>% 
  mutate(in_1 = Sequence %in% DDA_1_1_pep) %>% 
  mutate(in_2 = Sequence %in% DDA_1_2_pep) %>% 
  mutate(in_3 = Sequence %in% DDA_1_3_pep) %>% 
  mutate(in_4 = Sequence %in% DDA_1_4_pep)

DDA_1_filtered <- DDA_1 %>% 
  filter(rowSums(DDA_1[, 63:66]) >= 3)
```

DDA 5ng
```{r}
DDA_5 <- DDA_5 %>% 
  mutate(in_1 = Sequence %in% DDA_5_1_pep) %>% 
  mutate(in_2 = Sequence %in% DDA_5_2_pep) %>% 
  mutate(in_3 = Sequence %in% DDA_5_3_pep) %>% 
  mutate(in_4 = Sequence %in% DDA_5_4_pep)

DDA_5_filtered <- DDA_5 %>% 
  filter(rowSums(DDA_5[, 63:66]) >= 3)
```

DDA 10ng
```{r}
DDA_10 <- DDA_10 %>% 
  mutate(in_1 = Sequence %in% DDA_10_1_pep) %>% 
  mutate(in_2 = Sequence %in% DDA_10_2_pep) %>% 
  mutate(in_3 = Sequence %in% DDA_10_3_pep) %>% 
  mutate(in_4 = Sequence %in% DDA_10_4_pep)

DDA_10_filtered <- DDA_10 %>% 
  filter(rowSums(DDA_10[, 63:66]) >= 3)
```

DDA 100ng
```{r}
DDA_100 <- DDA_100 %>% 
  mutate(in_1 = Sequence %in% DDA_100_1_pep) %>% 
  mutate(in_2 = Sequence %in% DDA_100_2_pep) %>% 
  mutate(in_3 = Sequence %in% DDA_100_3_pep) %>% 
  mutate(in_4 = Sequence %in% DDA_100_4_pep)

DDA_100_filtered <- DDA_100 %>% 
  filter(rowSums(DDA_100[, 63:66]) >= 3)
```

DIA 1ng
```{r}
DIA_1 <- DIA_1 %>% 
  mutate(in_1 = PEP.StrippedSequence %in% DIA_1_1_pep) %>% 
  mutate(in_2 = PEP.StrippedSequence %in% DIA_1_2_pep) %>% 
  mutate(in_3 = PEP.StrippedSequence %in% DIA_1_3_pep) %>% 
  mutate(in_4 = PEP.StrippedSequence %in% DIA_1_4_pep)

DIA_1_filtered <- DIA_1 %>% 
  filter(rowSums(DIA_1[, 55:58]) >= 3)
```

DIA 5ng
```{r}
DIA_5 <- DIA_5 %>% 
  mutate(in_1 = PEP.StrippedSequence %in% DIA_5_1_pep) %>% 
  mutate(in_2 = PEP.StrippedSequence %in% DIA_5_2_pep) %>% 
  mutate(in_3 = PEP.StrippedSequence %in% DIA_5_3_pep) %>% 
  mutate(in_4 = PEP.StrippedSequence %in% DIA_5_4_pep)

DIA_5_filtered <- DIA_5 %>% 
  filter(rowSums(DIA_5[, 55:58]) >= 3)
```

DIA 10ng
```{r}
DIA_10 <- DIA_10 %>% 
  mutate(in_1 = PEP.StrippedSequence %in% DIA_10_1_pep) %>% 
  mutate(in_2 = PEP.StrippedSequence %in% DIA_10_2_pep) %>% 
  mutate(in_3 = PEP.StrippedSequence %in% DIA_10_3_pep) %>% 
  mutate(in_4 = PEP.StrippedSequence %in% DIA_10_4_pep)

DIA_10_filtered <- DIA_10 %>% 
  filter(rowSums(DIA_10[, 55:58]) >= 3)
```

DIA 100ng
```{r}
DIA_100 <- DIA_100 %>% 
  mutate(in_1 = PEP.StrippedSequence %in% DIA_100_1_pep) %>% 
  mutate(in_2 = PEP.StrippedSequence %in% DIA_100_2_pep) %>% 
  mutate(in_3 = PEP.StrippedSequence %in% DIA_100_3_pep) %>% 
  mutate(in_4 = PEP.StrippedSequence %in% DIA_100_4_pep)

DIA_100_filtered <- DIA_100 %>% 
  filter(rowSums(DIA_100[, 55:58]) >= 2)
```

## UpSet plot

```{r}
pep_list <- 
  list('DDA 1ng' = unique(DDA_1_filtered$Sequence),
       'DDA 5ng' = unique(DDA_5_filtered$Sequence),
       'DDA 10ng' = unique(DDA_10_filtered$Sequence),
       'DDA 100ng' = unique(DDA_100_filtered$Sequence),
       'DIA 1ng' = unique(DIA_1_filtered$PEP.StrippedSequence),
       'DIA 5ng' = unique(DIA_5_filtered$PEP.StrippedSequence),
       'DIA 10ng' = unique(DIA_10_filtered$PEP.StrippedSequence),
       'DIA 100ng' = unique(DIA_100_filtered$PEP.StrippedSequence))

palette <- c("pink3", "pink2", "pink1", "pink",
             "steelblue", "steelblue3", "steelblue2", "steelblue1")

upset(fromList(pep_list),
      sets = c('DIA 100ng', 'DIA 10ng', 'DIA 5ng', 'DIA 1ng',
               'DDA 100ng', 'DDA 10ng', 'DDA 5ng', 'DDA 1ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE, 
      sets.bar.color = palette,
      mainbar.y.label = "Number of identified peptides",
      nsets = 8,
      text.scale = 1.1)
```

# Correlation

## Load data
LIT Turbo DIA
```{r}
LITDIA_Turbo_1 <- read.csv2(paste0(lit_path, "20220502_LIT_Turbo_DIA_1ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Turbo_5 <- read.csv2(paste0(lit_path, "20220502_LIT_Turbo_DIA_5ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Turbo_10 <- read.csv2(paste0(lit_path, "20220502_LIT_Turbo_DIA_10ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Turbo_100 <- read.csv2(paste0(lit_path, "20220502_LIT_Turbo_DIA_100ng_40SPD_whisper100_1CV_auto.csv"))

LITDIA_Turbo_1$EG.IsImputed %>% table()
```

LIT Rapid DIA
```{r}
LITDIA_Rapid_1 <- read.csv2(paste0(lit_path, "20220421_LIT_Rapid_DIA_1ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Rapid_5 <- read.csv2(paste0(lit_path, "20220502_LIT_Rapid_DIA_5ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Rapid_10 <- read.csv2(paste0(lit_path, "20220502_LIT_Rapid_DIA_10ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Rapid_100 <- read.csv2(paste0(lit_path, "20220421_LIT_Rapid_DIA_100ng_40SPD_whisper100_1CV_auto.csv"))
```

LIT Normal DIA
```{r}
LITDIA_Normal_1 <- read.csv2(paste0(lit_path, "20220421_LIT_Normal_DIA_1ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Normal_5 <- read.csv2(paste0(lit_path, "20220502_LIT_Normal_DIA_5ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Normal_10 <- read.csv2(paste0(lit_path, "20220502_LIT_Normal_DIA_10ng_40SPD_whisper100_1CV_auto.csv"))
LITDIA_Normal_100 <- read.csv2(paste0(lit_path, "20220421_LIT_Normal_DIA_100ng_40SPD_whisper100_1CV_auto.csv"))
```

OT 7.5k DIA
```{r}
OTDIA_7k_1 <- read.csv2(paste0(ot_path, "20220421_OT_7k_DIA_1ng_40SPD_whisper100_1CV.csv"))
OTDIA_7k_5 <- read.csv2(paste0(ot_path, "20220502_OT_7k_DIA_5ng_40SPD_whisper100_1CV.csv"))
OTDIA_7k_10 <- read.csv2(paste0(ot_path, "20220502_OT_7k_DIA_10ng_40SPD_whisper100_1CV.csv"))
OTDIA_7k_100 <- read.csv2(paste0(ot_path, "20220421_OT_7k_DIA_100ng_40SPD_whisper100_1CV.csv"))
```

OT 15k DIA
```{r}
OTDIA_15k_1 <- read.csv2(paste0(ot_path, "20220421_OT_15k_DIA_1ng_40SPD_whisper100_1CV.csv"))
OTDIA_15k_5 <- read.csv2(paste0(ot_path, "20220509_OT_15k_DIA_5ng_40SPD_whisper100_1CV.csv"))
OTDIA_15k_10 <- read.csv2(paste0(ot_path, "20220502_OT_15k_DIA_10ng_40SPD_whisper100_1CV.csv"))
OTDIA_15k_100 <- read.csv2(paste0(ot_path, "20220425_OT_15k_DIA_100ng_40SPD_whisper100_1CV.csv"))
```

OT 30k DIA
```{r}
OTDIA_30k_1 <- read.csv2(paste0(ot_path, "20220421_OT_30k_DIA_1ng_40SPD_whisper100_1CV.csv"))
OTDIA_30k_5 <- read.csv2(paste0(ot_path, "20220509_OT_30k_DIA_5ng_40SPD_whisper100_1CV.csv"))
OTDIA_30k_10 <- read.csv2(paste0(ot_path, "20220502_OT_30k_DIA_10ng_40SPD_whisper100_1CV.csv"))
OTDIA_30k_100 <- read.csv2(paste0(ot_path, "20220425_OT_30k_DIA_100ng_40SPD_whisper100_1CV.csv"))
```

## Remove peptides found in less than 3 replicates and 

```{r}
filter_pep <- function(x) {
  x$FG.Quantity[as.logical(x$EG.IsImputed)] <- NA
  y <- x %>% 
  group_by(R.FileName, PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(FG.Quantity, na.rm = TRUE)) %>%  
  pivot_wider(names_from = R.FileName, 
              values_from = mean_quantity) %>%
    suppressMessages()
  z <- y %>% 
  mutate(na_nbr = rowSums(is.na(y[-1]))) %>%
  mutate(mean_quantity = rowMeans(y[2:ncol(y)], na.rm = TRUE)) %>%
  mutate(filtered = !na_nbr <= 1) %>% 
  select(-na_nbr) %>% 
  suppressMessages("`summarise()` has grouped output by 'R.FileName'. You can override using the `.groups` argument.")
  message("
Highlighted ", sum(z$filtered) , " peptide(s) found in less than ", ncol(y) -2, " replicates")
  
  return(z)
}
```


### 1 ng

```{r}
OTDIA_7k_1 <-  filter_pep(OTDIA_7k_1)
OTDIA_7k_1_filter <- OTDIA_7k_1[OTDIA_7k_1$filtered == FALSE,]
OTDIA_15k_1 <-  filter_pep(OTDIA_15k_1)
OTDIA_15k_1_filter <- OTDIA_15k_1[OTDIA_15k_1$filtered == FALSE,]
OTDIA_30k_1 <-  filter_pep(OTDIA_30k_1)
OTDIA_30k_1_filter <- OTDIA_30k_1[OTDIA_30k_1$filtered == FALSE,]

LITDIA_Turbo_1 <- filter_pep(LITDIA_Turbo_1)
LITDIA_Turbo_1_filter <- LITDIA_Turbo_1[LITDIA_Turbo_1$filtered == FALSE,]
LITDIA_Rapid_1 <- filter_pep(LITDIA_Rapid_1)
LITDIA_Rapid_1_filter <- LITDIA_Rapid_1[LITDIA_Rapid_1$filtered == FALSE,]
LITDIA_Normal_1 <- filter_pep(LITDIA_Normal_1)
LITDIA_Normal_1_filter <- LITDIA_Normal_1[LITDIA_Normal_1$filtered == FALSE,]
```

### 5 ng

```{r}
OTDIA_7k_5 <-  filter_pep(OTDIA_7k_5)
OTDIA_7k_5_filter <- OTDIA_7k_5[OTDIA_7k_5$filtered == FALSE,]
OTDIA_15k_5 <-  filter_pep(OTDIA_15k_5)
OTDIA_15k_5_filter <- OTDIA_15k_5[OTDIA_15k_5$filtered == FALSE,]
OTDIA_30k_5 <-  filter_pep(OTDIA_30k_5)
OTDIA_30k_5_filter <- OTDIA_30k_5[OTDIA_30k_5$filtered == FALSE,]

LITDIA_Turbo_5 <- filter_pep(LITDIA_Turbo_5)
LITDIA_Turbo_5_filter <- LITDIA_Turbo_5[LITDIA_Turbo_5$filtered == FALSE,]
LITDIA_Rapid_5 <- filter_pep(LITDIA_Rapid_5)
LITDIA_Rapid_5_filter <- LITDIA_Rapid_5[LITDIA_Rapid_5$filtered == FALSE,]
LITDIA_Normal_5 <- filter_pep(LITDIA_Normal_5)
LITDIA_Normal_5_filter <- LITDIA_Normal_5[LITDIA_Normal_5$filtered == FALSE,]
```

### 10 ng

```{r}
OTDIA_7k_10 <-  filter_pep(OTDIA_7k_10)
OTDIA_7k_10_filter <- OTDIA_7k_10[OTDIA_7k_10$filtered == FALSE,]
OTDIA_15k_10 <-  filter_pep(OTDIA_15k_10)
OTDIA_15k_10_filter <- OTDIA_15k_10[OTDIA_15k_10$filtered == FALSE,]
OTDIA_30k_10 <-  filter_pep(OTDIA_30k_10)
OTDIA_30k_10_filter <- OTDIA_30k_10[OTDIA_30k_10$filtered == FALSE,]

LITDIA_Turbo_10 <- filter_pep(LITDIA_Turbo_10)
LITDIA_Turbo_10_filter <- LITDIA_Turbo_10[LITDIA_Turbo_10$filtered == FALSE,]
LITDIA_Rapid_10 <- filter_pep(LITDIA_Rapid_10)
LITDIA_Rapid_10_filter <- LITDIA_Rapid_10[LITDIA_Rapid_10$filtered == FALSE,]
LITDIA_Normal_10 <- filter_pep(LITDIA_Normal_10)
LITDIA_Normal_10_filter <- LITDIA_Normal_10[LITDIA_Normal_10$filtered == FALSE,]
```

### 100 ng

```{r}
OTDIA_7k_100 <-  filter_pep(OTDIA_7k_100)
OTDIA_7k_100_filter <- OTDIA_7k_100[OTDIA_7k_100$filtered == FALSE,]
OTDIA_15k_100 <-  filter_pep(OTDIA_15k_100)
OTDIA_15k_100_filter <- OTDIA_15k_100[OTDIA_15k_100$filtered == FALSE,]
OTDIA_30k_100 <-  filter_pep(OTDIA_30k_100)
OTDIA_30k_100_filter <- OTDIA_30k_100[OTDIA_30k_100$filtered == FALSE,]

LITDIA_Turbo_100 <- filter_pep(LITDIA_Turbo_100)
LITDIA_Turbo_100_filter <- LITDIA_Turbo_100[LITDIA_Turbo_100$filtered == FALSE,]
LITDIA_Rapid_100 <- filter_pep(LITDIA_Rapid_100)
LITDIA_Rapid_100_filter <- LITDIA_Rapid_100[LITDIA_Rapid_100$filtered == FALSE,]
LITDIA_Normal_100 <- filter_pep(LITDIA_Normal_100)
LITDIA_Normal_100_filter <- LITDIA_Normal_100[LITDIA_Normal_100$filtered == FALSE,]
```

## Correlation plot

### 1 ng

```{r}
Turbo_vs_7k_1_facet <- 
  inner_join(OTDIA_7k_1_filter[,c(1,6)],
             LITDIA_Turbo_1_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Turbo_vs_7k_1_facet$method <- "LIT Turbo vs OT 7.5k"
Turbo_vs_7k_1_facet$input <- "1 ng"

Rapid_vs_15k_1_facet <-  
  inner_join(OTDIA_15k_1_filter[,c(1,6)],
             LITDIA_Rapid_1_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Rapid_vs_15k_1_facet$method <- "LIT Rapid vs OT 15k"
Rapid_vs_15k_1_facet$input <- "1 ng"

Normal_vs_30k_1_facet <-  
  inner_join(OTDIA_30k_1_filter[,c(1,6)],
             LITDIA_Normal_1_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Normal_vs_30k_1_facet$method <- "LIT Normal vs OT 30k"
Normal_vs_30k_1_facet$input <- "1 ng"
```

### 5 ng

```{r}
Turbo_vs_7k_5_facet <- 
  inner_join(OTDIA_7k_5_filter[,c(1,6)],
             LITDIA_Turbo_5_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Turbo_vs_7k_5_facet$method <- "LIT Turbo vs OT 7.5k"
Turbo_vs_7k_5_facet$input <- "5 ng"

Rapid_vs_15k_5_facet <-  
  inner_join(OTDIA_15k_5_filter[,c(1,6)],
             LITDIA_Rapid_5_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Rapid_vs_15k_5_facet$method <- "LIT Rapid vs OT 15k"
Rapid_vs_15k_5_facet$input <- "5 ng"

Normal_vs_30k_5_facet <-  
  inner_join(OTDIA_30k_5_filter[,c(1,6)],
             LITDIA_Normal_5_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Normal_vs_30k_5_facet$method <- "LIT Normal vs OT 30k"
Normal_vs_30k_5_facet$input <- "5 ng"
```

### 10 ng

```{r}
Turbo_vs_7k_10_facet <- 
  inner_join(OTDIA_7k_10_filter[,c(1,6)],
             LITDIA_Turbo_10_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Turbo_vs_7k_10_facet$method <- "LIT Turbo vs OT 7.5k"
Turbo_vs_7k_10_facet$input <- "10 ng"

Rapid_vs_15k_10_facet <-  
  inner_join(OTDIA_15k_10_filter[,c(1,6)],
             LITDIA_Rapid_10_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Rapid_vs_15k_10_facet$method <- "LIT Rapid vs OT 15k"
Rapid_vs_15k_10_facet$input <- "10 ng"

Normal_vs_30k_10_facet <-  
  inner_join(OTDIA_30k_10_filter[,c(1,6)],
             LITDIA_Normal_10_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Normal_vs_30k_10_facet$method <- "LIT Normal vs OT 30k"
Normal_vs_30k_10_facet$input <- "10 ng"
```

### 100 ng  

```{r}
Turbo_vs_7k_100_facet <-  
  inner_join(OTDIA_7k_100_filter[,c(1,6)],
             LITDIA_Turbo_100_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Turbo_vs_7k_100_facet$method <- "LIT Turbo vs OT 7.5k"
Turbo_vs_7k_100_facet$input <- "100 ng"

Rapid_vs_15k_100_facet <- 
  inner_join(OTDIA_15k_100_filter[,c(1,6)],
             LITDIA_Rapid_100_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Rapid_vs_15k_100_facet$method <- "LIT Rapid vs OT 15k"
Rapid_vs_15k_100_facet$input <- "100 ng"

Normal_vs_30k_100_facet <- 
  inner_join(OTDIA_30k_100_filter[,c(1,6)],
             LITDIA_Normal_100_filter[,c(1,6)],
             by = "PEP.StrippedSequence",
             suffix = c("_OT", "_LIT"))
Normal_vs_30k_100_facet$method <- "LIT Normal vs OT 30k"
Normal_vs_30k_100_facet$input <- "100 ng"
```

### Join

```{r}
facet <- rbind(Turbo_vs_7k_1_facet, Rapid_vs_15k_1_facet, Normal_vs_30k_1_facet,
               Turbo_vs_7k_5_facet, Rapid_vs_15k_5_facet, Normal_vs_30k_5_facet,
               Turbo_vs_7k_10_facet, Rapid_vs_15k_10_facet, Normal_vs_30k_10_facet,
               Turbo_vs_7k_100_facet, Rapid_vs_15k_100_facet, Normal_vs_30k_100_facet)

facet$method <- factor(facet$method,
                       levels = c("LIT Turbo vs OT 7.5k",
                                  "LIT Rapid vs OT 15k",
                                  "LIT Normal vs OT 30k"))
facet$input = factor(facet$input, levels = unique(facet$input))
```

### Plot

```{r}
corr_plot <- facet %>% 
  ggplot(aes(x = mean_quantity_OT, y = mean_quantity_LIT)) +
  geom_pointdensity(size = 1.5)+
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 90,
                                   vjust = 0.3),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        strip.text.x = element_text(size = 27),
        strip.text.y = element_text(size = 27, vjust = 1.2),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.12)) +
  geom_smooth(method = lm,
              se = FALSE,
              color = "red",
              size = 1.2)+
  stat_cor(method = "pearson",
           aes(label = ..r.label..),
           r.digits = 3, color = "red",
           size = 7,
           label.x.npc = 0,
           label.y.npc = 0.9)+
  labs(x = "OT Abundance (log10)",
       y = "LIT Abundance (log10)",
       title = "C") +
  scale_y_log10(breaks = c(1000, 100000)) +
  scale_x_log10() +
  facet_grid(input~method)

labels <- paste0(c(sum(facet$method == "LIT Turbo vs OT 7.5k" & facet$input == "1 ng"),
                   sum(facet$method == "LIT Rapid vs OT 15k" & facet$input == "1 ng"),
                   sum(facet$method == "LIT Normal vs OT 30k" & facet$input == "1 ng"),
                   sum(facet$method == "LIT Turbo vs OT 7.5k" & facet$input == "5 ng"),
                   sum(facet$method == "LIT Rapid vs OT 15k" & facet$input == "5 ng"),
                   sum(facet$method == "LIT Normal vs OT 30k" & facet$input == "5 ng"),
                   sum(facet$method == "LIT Turbo vs OT 7.5k" & facet$input == "10 ng"),
                   sum(facet$method == "LIT Rapid vs OT 15k" & facet$input == "10 ng"),
                   sum(facet$method == "LIT Normal vs OT 30k" & facet$input == "10 ng"),
                   sum(facet$method == "LIT Turbo vs OT 7.5k" & facet$input == "100 ng"),
                   sum(facet$method == "LIT Rapid vs OT 15k" & facet$input == "100 ng"),
                   sum(facet$method == "LIT Normal vs OT 30k" & facet$input == "100 ng")),
                 " pep.")

data_labels <- 
  data.frame(method = as.factor(rep(c("LIT Turbo vs OT 7.5k",
                                      "LIT Rapid vs OT 15k",
                                      "LIT Normal vs OT 30k"),4)),
             input = as.factor(c(rep("1 ng",3), rep("5 ng",3),rep("10 ng",3), rep("100 ng",3))),
             label = labels)

corr_plot <- corr_plot +
  geom_text(x = -Inf, y = Inf,
            hjust = -0.15, vjust = 3.2,
            aes(label = labels, group = NULL), data = data_labels,
            size = 7,
            face = "bold")
corr_plot
```

```{r}
temp <- data.frame(corr = c(NA, 0.887, 0.892, 0.905, 0.905, 0.879, 0.877, 0.916, 0.908, 0.906, 0.89, 0.887),
           input = c(rep("1 ng", 3), rep("5 ng", 3), rep("10 ng", 3), rep("100 ng", 3)),
           method = rep(c("LIT Turbo vs OT 7.5k",
                                      "LIT Rapid vs OT 15k",
                                      "LIT Normal vs OT 30k"),4))

temp$method <- factor(temp$method, levels = unique(temp$method))
temp$input <- factor(temp$input, levels = unique(temp$input))


temp %>%
  ggplot(aes(x = input, y = corr, group = method, color = method))+
  geom_line(size = 1.5)+
  geom_point(size = 2)+
  scale_color_manual(values =  c("#EEB9CF", "#DF7FA7", "#D35087"))
```


# LIT Abundance distribution

## Highlight peptides found in corresponding OT method

### 1 ng

```{r}
#Turbo
LITDIA_Turbo_1_filter$in_OT <- 
  LITDIA_Turbo_1_filter$PEP.StrippedSequence %in%
  OTDIA_7k_1_filter$PEP.StrippedSequence
LITDIA_Turbo_1_filter$method <- "Turbo"

#Rapid
LITDIA_Rapid_1_filter$in_OT <- 
  LITDIA_Rapid_1_filter$PEP.StrippedSequence %in%
  OTDIA_15k_1_filter$PEP.StrippedSequence
LITDIA_Rapid_1_filter$method <- "Rapid"

#Normal
LITDIA_Normal_1_filter$in_OT <- 
  LITDIA_Normal_1_filter$PEP.StrippedSequence %in%
  OTDIA_30k_1_filter$PEP.StrippedSequence
LITDIA_Normal_1_filter$method <- "Normal"

#Input
LITDIA_Turbo_1_filter$input <-
  LITDIA_Rapid_1_filter$input <-
  LITDIA_Normal_1_filter$input <- "1 ng"
```

### 5 ng

```{r}
#Turbo
LITDIA_Turbo_5_filter$in_OT <- 
  LITDIA_Turbo_5_filter$PEP.StrippedSequence %in%
  OTDIA_7k_5_filter$PEP.StrippedSequence
LITDIA_Turbo_5_filter$method <- "Turbo"

#Rapid
LITDIA_Rapid_5_filter$in_OT <- 
  LITDIA_Rapid_5_filter$PEP.StrippedSequence %in%
  OTDIA_15k_5_filter$PEP.StrippedSequence
LITDIA_Rapid_5_filter$method <- "Rapid"

#Normal
LITDIA_Normal_5_filter$in_OT <- 
  LITDIA_Normal_5_filter$PEP.StrippedSequence %in%
  OTDIA_30k_5_filter$PEP.StrippedSequence
LITDIA_Normal_5_filter$method <- "Normal"

#Input
LITDIA_Turbo_5_filter$input <-
  LITDIA_Rapid_5_filter$input <-
  LITDIA_Normal_5_filter$input <- "5 ng"
```

### 10 ng

```{r}
#Turbo
LITDIA_Turbo_10_filter$in_OT <- 
  LITDIA_Turbo_10_filter$PEP.StrippedSequence %in%
  OTDIA_7k_10_filter$PEP.StrippedSequence
LITDIA_Turbo_10_filter$method <- "Turbo"

#Rapid
LITDIA_Rapid_10_filter$in_OT <- 
  LITDIA_Rapid_10_filter$PEP.StrippedSequence %in%
  OTDIA_15k_10_filter$PEP.StrippedSequence
LITDIA_Rapid_10_filter$method <- "Rapid"

#Normal
LITDIA_Normal_10_filter$in_OT <- 
  LITDIA_Normal_10_filter$PEP.StrippedSequence %in%
  OTDIA_30k_10_filter$PEP.StrippedSequence
LITDIA_Normal_10_filter$method <- "Normal"

#Input
LITDIA_Turbo_10_filter$input <-
  LITDIA_Rapid_10_filter$input <-
  LITDIA_Normal_10_filter$input <- "10 ng"
```

### 100 ng

```{r}
#Turbo
LITDIA_Turbo_100_filter$in_OT <- 
  LITDIA_Turbo_100_filter$PEP.StrippedSequence %in%
  OTDIA_7k_100_filter$PEP.StrippedSequence
LITDIA_Turbo_100_filter$method <- "Turbo"

#Rapid
LITDIA_Rapid_100_filter$in_OT <- 
  LITDIA_Rapid_100_filter$PEP.StrippedSequence %in%
  OTDIA_15k_100_filter$PEP.StrippedSequence
LITDIA_Rapid_100_filter$method <- "Rapid"

#Normal
LITDIA_Normal_100_filter$in_OT <- 
  LITDIA_Normal_100_filter$PEP.StrippedSequence %in%
  OTDIA_30k_100_filter$PEP.StrippedSequence
LITDIA_Normal_100_filter$method <- "Normal"

#Input
LITDIA_Turbo_100_filter$input <-
  LITDIA_Rapid_100_filter$input <- 
  LITDIA_Normal_100_filter$input <- "100 ng"
```

## Joining

```{r}
OT_in_LIT <- 
  rbind(LITDIA_Turbo_1_filter[,c(1,6:10)], LITDIA_Turbo_5_filter[,c(1,6:10)],
        LITDIA_Turbo_10_filter[,c(1,6:10)], LITDIA_Turbo_100_filter[,c(1,6:10)],
        LITDIA_Rapid_1_filter[,c(1,6:10)], LITDIA_Rapid_5_filter[,c(1,6:10)],
        LITDIA_Rapid_10_filter[,c(1,6:10)], LITDIA_Rapid_100_filter[,c(1,6:10)],
        LITDIA_Normal_1_filter[,c(1,6:10)], LITDIA_Normal_5_filter[,c(1,6:10)],
        LITDIA_Normal_10_filter[,c(1,6:10)], LITDIA_Normal_100_filter[,c(1,6:10)]) 

OT_in_LIT$method <- factor(OT_in_LIT$method,
                       levels = unique(OT_in_LIT$method))
OT_in_LIT$input <- factor(OT_in_LIT$input,
                       levels = unique(OT_in_LIT$input))
```


## Plot

```{r}
OT_in_LIT_plot <- OT_in_LIT %>% 
  ggplot(aes(x = mean_quantity, fill = in_OT))+
  geom_histogram(bins = 40,
                 position = "identity",
                 alpha = 0.4)+
  scale_x_log10()+
  scale_y_continuous(breaks = c(0, 500, 1000)) +
  scale_fill_manual(values = c("grey20", "red"),
                    labels = c("LIT only", "LIT and OT"))+
  labs(x = "DIA-LIT Abundance (log10)",
       y = "Identified peptides",
       title = "D")+
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.3),
        legend.position = c(0.915, 0.927),
        legend.background = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 27),
        legend.title = element_blank(),
        legend.text = element_text(size = 24),
        strip.text.x = element_text(size = 27),
        strip.text.y = element_text(size = 27, vjust = 1.2),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.12)) +
  facet_grid(input ~ method)

labels1 <- 
  paste0(c(sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Rapid" &  OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == FALSE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == FALSE)),
         " pep.")

                       
data_labels1 <- 
  data.frame(method = as.factor(rep(c("Turbo", "Rapid", "Normal"),4)),
             input = as.factor(c(rep("1 ng",3), rep("5 ng",3), rep("10 ng",3), rep("100 ng",3))),
             label = labels1,
             in_OT = rep(FALSE, 12))

labels2<- 
  paste0(c(sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "1 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "5 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Rapid" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "10 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Turbo" & OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Rapid" &  OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == TRUE),
           sum(OT_in_LIT$method == "Normal" & OT_in_LIT$input == "100 ng" & OT_in_LIT$in_OT == TRUE)),
         " pep.")
                       
data_labels2 <- 
  data.frame(method = as.factor(rep(c("Turbo", "Rapid", "Normal"),4)),
             input = as.factor(c(rep("1 ng",3), rep("5 ng",3), rep("10 ng",3), rep("100 ng",3))),
             label = labels2,
             in_OT = rep(TRUE, 12))

OT_in_LIT_plot <- OT_in_LIT_plot +
  geom_text(x = -Inf, y = Inf,
            hjust = -0.1, vjust = 1.82,
            aes(label = label, group = NULL), data = data_labels1,
            color = "grey50",
            size = 7,
            face = "bold")+
  geom_text(x = -Inf, y = Inf,
            hjust = -0.1, vjust = 3.32,
            aes(label = label, group = NULL), data = data_labels2,
            color = "red",
            size = 7,
            face = "bold")
OT_in_LIT_plot
```

## temp

### Turbo

```{r}
seq_Turbo_1 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Turbo" & input == "1 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Turbo_5 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Turbo" & input == "5 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Turbo_10 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Turbo" & input == "10 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Turbo_100 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Turbo" & input == "100 ng") %>% 
  pull(PEP.StrippedSequence)

seq_list <- 
  list('Turbo 1ng' = seq_Turbo_1,
       'Turbo 5ng' = seq_Turbo_5,
       'Turbo 10ng' = seq_Turbo_10,
       'Turbo 100ng' = seq_Turbo_100)

upset_Turbo <- upset(fromList(seq_list),
      sets = c('Turbo 100ng', 'Turbo 10ng', 'Turbo 5ng', 'Turbo 1ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = teera_palette[c(3, 2, 4, 1)],
      main.bar.color = "#384258",
      nintersects = 9)
upset_Turbo
```

### Rapid

```{r}
seq_Rapid_1 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Rapid" & input == "1 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Rapid_5 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Rapid" & input == "5 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Rapid_10 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Rapid" & input == "10 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Rapid_100 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Rapid" & input == "100 ng") %>% 
  pull(PEP.StrippedSequence)

seq_list <- 
  list('Rapid 1ng' = seq_Rapid_1,
       'Rapid 5ng' = seq_Rapid_5,
       'Rapid 10ng' = seq_Rapid_10,
       'Rapid 100ng' = seq_Rapid_100)

upset_Rapid <- upset(fromList(seq_list),
      sets = c('Rapid 100ng', 'Rapid 10ng', 'Rapid 5ng', 'Rapid 1ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = teera_palette[c(3, 2, 4, 1)],
      main.bar.color = "#384258",
      nintersects = 9)
upset_Rapid
```

### Normal

```{r}
seq_Normal_1 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Normal" & input == "1 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Normal_5 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Normal" & input == "5 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Normal_10 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Normal" & input == "10 ng") %>% 
  pull(PEP.StrippedSequence)
seq_Normal_100 <- OT_in_LIT %>%
  filter(in_OT == FALSE & method == "Normal" & input == "100 ng") %>% 
  pull(PEP.StrippedSequence)

seq_list <- 
  list('Normal 1ng' = seq_Normal_1,
       'Normal 5ng' = seq_Normal_5,
       'Normal 10ng' = seq_Normal_10,
       'Normal 100ng' = seq_Normal_100)

upset_Normal <- upset(fromList(seq_list),
      sets = c('Normal 100ng', 'Normal 10ng', 'Normal 5ng', 'Normal 1ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = teera_palette[c(3, 2, 4, 1)],
      nintersects = 9,
      main.bar.color = "#384258")
upset_Normal
```

### 1 ng
```{r}
seq_list <- 
  list('Turbo 1ng' = seq_Turbo_1,
       'Rapid 1ng' = seq_Rapid_1,
       'Normal 1ng' = seq_Normal_1)

upset_1ng <- upset(fromList(seq_list),
      sets = c('Normal 1ng', 'Rapid 1ng', 'Turbo 1ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = c("#D35087", "#DF7FA7", "#EEB9CF"),
      empty.intersections = TRUE,
      main.bar.color = "#384258")
upset_1ng
```

### 5 ng
```{r}
seq_list <- 
  list('Turbo 5ng' = seq_Turbo_5,
       'Rapid 5ng' = seq_Rapid_5,
       'Normal 5ng' = seq_Normal_5)

upset_5ng <- upset(fromList(seq_list),
      sets = c('Normal 5ng', 'Rapid 5ng', 'Turbo 5ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = c("#D35087", "#DF7FA7", "#EEB9CF"),
      main.bar.color = "#384258")
upset_5ng
```

### 10 ng
```{r}
seq_list <- 
  list('Turbo 10ng' = seq_Turbo_10,
       'Rapid 10ng' = seq_Rapid_10,
       'Normal 10ng' = seq_Normal_10)

upset_10ng <- upset(fromList(seq_list),
      sets = c('Normal 10ng', 'Rapid 10ng', 'Turbo 10ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = c("#D35087", "#DF7FA7", "#EEB9CF"),
      main.bar.color = "#384258")
upset_10ng
```

### 100 ng

```{r}
seq_list <- 
  list('Turbo 100ng' = seq_Turbo_100,
       'Rapid 100ng' = seq_Rapid_100,
       'Normal 100ng' = seq_Normal_100)

upset_100ng <- upset(fromList(seq_list),
      sets = c('Normal 100ng', 'Rapid 100ng', 'Turbo 100ng'),
      order.by = "freq", 
      keep.order = TRUE,
      set_size.show = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      sets.bar.color = c("#D35087", "#DF7FA7", "#EEB9CF"),
      main.bar.color = "#384258")
upset_100ng
```

### combined

```{r}
#(upset_Turbo + upset_Rapid + upset_Normal)/
#  (upset_1ng + upset_5ng + upset_10ng + upset_100ng)
```


# OT Abundance distribution

## Highlight peptides found in corresponding LIT method

### 1 ng

```{r}
#7k
OTDIA_7k_1_filter$in_LIT <- 
  OTDIA_7k_1_filter$PEP.StrippedSequence %in%
  LITDIA_Turbo_1_filter$PEP.StrippedSequence
OTDIA_7k_1_filter$method <- "7k"

#15k
OTDIA_15k_1_filter$in_LIT <- 
  OTDIA_15k_1_filter$PEP.StrippedSequence %in%
  LITDIA_Rapid_1_filter$PEP.StrippedSequence
OTDIA_15k_1_filter$method <- "15k"

#15k
OTDIA_30k_1_filter$in_LIT <- 
  OTDIA_30k_1_filter$PEP.StrippedSequence %in%
  LITDIA_Normal_1_filter$PEP.StrippedSequence
OTDIA_30k_1_filter$method <- "30k"

#Input
OTDIA_7k_1_filter$input <-
  OTDIA_15k_1_filter$input <-
  OTDIA_30k_1_filter$input <- "1 ng"
```

### 100 ng

```{r}
#7k
OTDIA_7k_100_filter$in_LIT <- 
  OTDIA_7k_100_filter$PEP.StrippedSequence %in%
  LITDIA_Turbo_100_filter$PEP.StrippedSequence
OTDIA_7k_100_filter$method <- "7k"

#15k
OTDIA_15k_100_filter$in_LIT <- 
  OTDIA_15k_100_filter$PEP.StrippedSequence %in%
  LITDIA_Rapid_100_filter$PEP.StrippedSequence
OTDIA_15k_100_filter$method <- "15k"

#15k
OTDIA_30k_100_filter$in_LIT <- 
  OTDIA_30k_100_filter$PEP.StrippedSequence %in%
  LITDIA_Normal_100_filter$PEP.StrippedSequence
OTDIA_30k_100_filter$method <- "30k"

#Input
OTDIA_7k_100_filter$input <-
  OTDIA_15k_100_filter$input <-
  OTDIA_30k_100_filter$input <- "100 ng"
```

## Joining

```{r}
LIT_in_OT <- 
  rbind(OTDIA_7k_1_filter[,c(1,6:10)], OTDIA_7k_100_filter[,c(1,6:10)],
        OTDIA_15k_1_filter[,c(1,6:10)], OTDIA_15k_100_filter[,c(1,6:10)],
        OTDIA_30k_1_filter[,c(1,6:10)], OTDIA_30k_100_filter[,c(1,6:10)]) 

LIT_in_OT$method <- factor(LIT_in_OT$method,
                       levels = unique(LIT_in_OT$method))
```

## Plot

```{r}
LIT_in_OT_plot <- LIT_in_OT %>% 
  ggplot(aes(x = mean_quantity, fill = in_LIT))+
  geom_histogram(bins = 40,
                 position = "identity",
                 alpha = 0.4)+
  scale_x_log10()+
  scale_fill_manual(values = c("grey20", "red"),
                    labels = c("OT only", "OT and LIT"))+
  labs(x = "OTDIA Abundance (log10)",
       y = "Peptide number",
       fill = "Found in")+
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.3)) +
  facet_grid(input ~ method)

labels1 <- c(paste0(sum(LIT_in_OT$method == "7k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                  " peptides"),
             paste0(sum(LIT_in_OT$method == "15k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "30k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "7k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                  " peptides"),
             paste0(sum(LIT_in_OT$method == "15k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "30k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == FALSE),
                    " peptides"))
                       
data_labels1 <- 
  data.frame(method = as.factor(rep(c("7k", "15k", "30k"),2)),
             input = as.factor(c(rep("1 ng",3), rep("100 ng",3))),
             label = labels1,
             in_LIT = rep(FALSE, 6))

labels2 <- c(paste0(sum(LIT_in_OT$method == "7k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                  " peptides"),
             paste0(sum(LIT_in_OT$method == "15k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "30k" & 
                          LIT_in_OT$input == "1 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "7k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                  " peptides"),
             paste0(sum(LIT_in_OT$method == "15k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                    " peptides"),
             paste0(sum(LIT_in_OT$method == "30k" & 
                          LIT_in_OT$input == "100 ng" &
                          LIT_in_OT$in_LIT == TRUE),
                    " peptides"))
                       
data_labels2 <- 
  data.frame(method = as.factor(rep(c("7k", "15k", "30k"),2)),
             input = as.factor(c(rep("1 ng",3), rep("100 ng",3))),
             label = labels1,
             in_LIT = rep(TRUE, 6))

LIT_in_OT_plot <- LIT_in_OT_plot +
  geom_text(x = -Inf, y = Inf,
            hjust = -0.1, vjust = 1.5,
            aes(label = labels1, group = NULL), data = data_labels1,
            size = 3.2,
            color = "grey50")+
  geom_text(x = -Inf, y = Inf,
            hjust = -0.1, vjust = 3,
            aes(label = labels2, group = NULL), data = data_labels2,
            size = 3.2,
            color = "red")
LIT_in_OT_plot
```

```{r}
OT_in_LIT_plot
LIT_in_OT_plot
```

For 1ng, only highly abundant peptides are found with OT
For 100 ng, OT yields a higher number of peptides, regardless of the abundance but peptides with low abundance are less shared. 

# Peptide overlapping between different inputs

```{r}
Turbo_pep_list <- 
  list('Turbo 1 ng' = LITDIA_Turbo_1_filter$PEP.StrippedSequence,
       'Turbo 5 ng' = LITDIA_Turbo_5_filter$PEP.StrippedSequence,
       'Turbo 10 ng' = LITDIA_Turbo_10_filter$PEP.StrippedSequence,
       'Turbo 100 ng' = LITDIA_Turbo_100_filter$PEP.StrippedSequence)

upset(fromList(Turbo_pep_list),
      sets = c('Turbo 100 ng', 'Turbo 10 ng', 'Turbo 5 ng', 'Turbo 1 ng'),
      order.by = "freq", 
      keep.order = TRUE,
      mainbar.y.label = "Number of identified peptides",
      text.scale = 1.1,
      matrix.color = c("tomato3"),
      sets.bar.color = c("#D35087","#DF7FA7", "#EEB9CF","#F6D9E5" ),
      main.bar.color = "#555454",
      nintersects = 10)
```

# CV

## Compute CV

### 1 ng

LITDIA_Turbo auto
```{r}
LITDIA_Turbo_1_CV <- LITDIA_Turbo_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Turbo",
         input = "1 ng")
```

LITDIA_Rapid
```{r}
LITDIA_Rapid_1_CV <- LITDIA_Rapid_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid",
         input = "1 ng")
```

LITDIA_Normal
```{r}
LITDIA_Normal_1_CV <- LITDIA_Normal_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal",
         input = "1 ng")
```

OTDIA_7k 
```{r}
OTDIA_7k_1_CV <- OTDIA_7k_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_7k",
         input = "1 ng")
```

OTDIA_15k 
```{r}
OTDIA_15k_1_CV <- OTDIA_15k_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_15k",
         input = "1 ng")
```

OTDIA_30k 
```{r}
OTDIA_30k_1_CV <- OTDIA_30k_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_30k",
         input = "1 ng")
```

### 5 ng

LITDIA_Turbo auto
```{r}
LITDIA_Turbo_5_CV <- LITDIA_Turbo_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Turbo",
         input = "5 ng")
```

LITDIA_Rapid
```{r}
LITDIA_Rapid_5_CV <- LITDIA_Rapid_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid",
         input = "5 ng")
```

LITDIA_Normal
```{r}
LITDIA_Normal_5_CV <- LITDIA_Normal_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal",
         input = "5 ng")
```

OTDIA_7k 
```{r}
OTDIA_7k_5_CV <- OTDIA_7k_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_7k",
         input = "5 ng")
```

OTDIA_15k 
```{r}
OTDIA_15k_5_CV <- OTDIA_15k_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_15k",
         input = "5 ng")
```

OTDIA_30k 
```{r}
OTDIA_30k_5_CV <- OTDIA_30k_5[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_30k",
         input = "5 ng")
```

### 10 ng

LITDIA_Turbo auto
```{r}
LITDIA_Turbo_10_CV <- LITDIA_Turbo_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Turbo",
         input = "10 ng")
```

LITDIA_Rapid
```{r}
LITDIA_Rapid_10_CV <- LITDIA_Rapid_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid",
         input = "10 ng")
```

LITDIA_Normal
```{r}
LITDIA_Normal_10_CV <- LITDIA_Normal_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal",
         input = "10 ng")
```

OTDIA_7k 
```{r}
OTDIA_7k_10_CV <- OTDIA_7k_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_7k",
         input = "10 ng")
```

OTDIA_15k 
```{r}
OTDIA_15k_10_CV <- OTDIA_15k_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_15k",
         input = "10 ng")
```

OTDIA_30k 
```{r}
OTDIA_30k_10_CV <- OTDIA_30k_10[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_30k",
         input = "10 ng")
```

### 100 ng 

LITDIA_Turbo
```{r}
LITDIA_Turbo_100_CV <- LITDIA_Turbo_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Turbo",
         input = "100 ng")
```

LITDIA_Rapid
```{r}
LITDIA_Rapid_100_CV <- LITDIA_Rapid_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid",
         input = "100 ng")
```

LITDIA_Normal
```{r}
LITDIA_Normal_100_CV <- LITDIA_Normal_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal",
         input = "100 ng")
```

OTDIA_7k 
```{r}
OTDIA_7k_100_CV <- OTDIA_7k_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_7k",
         input = "100 ng")
```

OTDIA_15k 
```{r}
OTDIA_15k_100_CV <- OTDIA_15k_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_15k",
         input = "100 ng")
```

OTDIA_30k 
```{r}
OTDIA_30k_100_CV <- OTDIA_30k_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "OTDIA_30k",
         input = "100 ng")
```

## Join

```{r}
CV_joined <- 
  rbind(LITDIA_Turbo_1_CV, LITDIA_Rapid_1_CV, LITDIA_Normal_1_CV,
      OTDIA_7k_1_CV, OTDIA_15k_1_CV, OTDIA_30k_1_CV,
      LITDIA_Turbo_5_CV, LITDIA_Rapid_5_CV, LITDIA_Normal_5_CV,
      OTDIA_7k_5_CV, OTDIA_15k_5_CV, OTDIA_30k_5_CV,
      LITDIA_Turbo_10_CV, LITDIA_Rapid_10_CV, LITDIA_Normal_10_CV,
      OTDIA_7k_10_CV, OTDIA_15k_10_CV, OTDIA_30k_10_CV,
      LITDIA_Turbo_100_CV, LITDIA_Rapid_100_CV, LITDIA_Normal_100_CV,
      OTDIA_7k_100_CV, OTDIA_15k_100_CV, OTDIA_30k_100_CV)

CV_joined$input <- factor(CV_joined$input, levels = unique(CV_joined$input))
```


## Plot CV

```{r}
CV_joined$method <- factor(CV_joined$method, levels = unique(CV_joined$method))
CV_joined$indiv <- paste(CV_joined$method, CV_joined$input, sep = " ")
CV_joined$method %>% table()

CV_plot <- CV_joined %>% 
  ggplot(aes(x = as.factor(input), 
             y = CV*100, 
             fill = as.factor(indiv)))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9)+
  scale_fill_manual(values = c(rep(teera_palette[c(1: 4)], 3),
                               rep(teera_palette[c(5: 8)], 3))) +
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(x = "Input",
       y = "CV (%)",
       title = "B")+
  theme(legend.position = "none",
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1),
        strip.text.x = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.08))+
  facet_wrap(~method, labeller = labeller(method = 
    c("LITDIA_Turbo" = "LIT Turbo",
      "LITDIA_Rapid" = "LIT Rapid",
      "LITDIA_Normal" = "LIT Normal",
      "OTDIA_7k" = "OT 7.5k",
      "OTDIA_15k" = "OT 15k",
      "OTDIA_30k" = "OT 30k")))+
  coord_cartesian(ylim = c(0.03, 87))


CV_plot

CV_joined %>% 
  filter(input == "1 ng") %>% 
  group_by(method) %>% 
  summarise(median_CV = median(CV, na.rm = TRUE))
```

```{r}
inner_join(LITDIA_Turbo_1_CV[, c(1, 4)],
           OTDIA_7k_1_CV[, c(1, 4)],
           by = "PEP.StrippedSequence") %>% 
  mutate(LIT_OT_ratio = log10(CV.x/CV.y)) %>% 
  mutate(LIT_higher = LIT_OT_ratio >= 0) %>% 
  ggplot(aes(x = LIT_OT_ratio,
             fill = LIT_higher)) +
  geom_histogram()

inner_join(LITDIA_Rapid_1_CV[, c(1, 4)],
           OTDIA_15k_1_CV[, c(1, 4)],
           by = "PEP.StrippedSequence") %>% 
  mutate(LIT_OT_ratio = log10(CV.x/CV.y)) %>% 
  mutate(LIT_higher = LIT_OT_ratio >= 0) %>% 
  ggplot(aes(x = LIT_OT_ratio,
             fill = LIT_higher)) +
  geom_histogram()

inner_join(LITDIA_Normal_1_CV[, c(1, 4)],
           OTDIA_30k_1_CV[, c(1, 4)],
           by = "PEP.StrippedSequence") %>% 
  mutate(LIT_OT_ratio = log10(CV.x/CV.y)) %>% 
  mutate(LIT_higher = LIT_OT_ratio >= 0) %>% 
  ggplot(aes(x = LIT_OT_ratio,
             fill = LIT_higher)) +
  geom_histogram()
```

# Identified peptides

```{r}
sum(!is.na(LITDIA_Turbo_1[, 2]))
sum(!is.na(LITDIA_Turbo_1[, 3]))
sum(!is.na(LITDIA_Turbo_1[, 4]))
sum(!is.na(LITDIA_Turbo_1[, 5]))

id_LITDIA_Turbo_1 <- id_LITDIA_Turbo_5 <- id_LITDIA_Turbo_10 <- id_LITDIA_Turbo_100 <- 
  id_LITDIA_Rapid_1 <- id_LITDIA_Rapid_5 <- id_LITDIA_Rapid_10 <- id_LITDIA_Rapid_100 <-
  id_LITDIA_Normal_1 <- id_LITDIA_Normal_5 <- id_LITDIA_Normal_10 <- id_LITDIA_Normal_100 <-  
  id_OTDIA_7k_1 <- id_OTDIA_7k_5 <- id_OTDIA_7k_10 <- id_OTDIA_7k_100 <- 
  id_OTDIA_15k_1 <- id_OTDIA_15k_5 <- id_OTDIA_15k_10 <- id_OTDIA_15k_100 <- 
  id_OTDIA_30k_1 <- id_OTDIA_30k_5 <- id_OTDIA_30k_10 <- id_OTDIA_30k_100 <- rep(NA, 4)
```

## 1 ng

OT 7.5k DIA
```{r}
for(i in 2:5){
  id_OTDIA_7k_1[i-1] <- sum(!is.na(OTDIA_7k_1[, i]))}
```
OT 15k DIA
```{r}
for(i in 2:5){
  id_OTDIA_15k_1[i-1] <- sum(!is.na(OTDIA_15k_1[, i]))}
```

OT 30k DIA
```{r}
for(i in 2:5){
  id_OTDIA_30k_1[i-1] <- sum(!is.na(OTDIA_30k_1[, i]))}
```

LIT Turbo DIA auto
```{r}
for(i in 2:5){
id_LITDIA_Turbo_1[i-1] <- sum(!is.na(LITDIA_Turbo_1[, i]))}
```

LIT Rapid DIA
```{r}
for(i in 2:5){
id_LITDIA_Rapid_1[i-1] <- sum(!is.na(LITDIA_Rapid_1[, i]))}
```

LIT Normal DIA
```{r}
for(i in 2:5){
id_LITDIA_Normal_1[i-1] <- sum(!is.na(LITDIA_Normal_1[, i]))}
```

## 5 ng

OT 7.5k DIA
```{r}
for(i in 2:5){
  id_OTDIA_7k_5[i-1] <- sum(!is.na(OTDIA_7k_5[, i]))}
```

OT 15k DIA
```{r}
for(i in 2:5){
  id_OTDIA_15k_5[i-1] <- sum(!is.na(OTDIA_15k_5[, i]))}
```

OT 30k DIA
```{r}
for(i in 2:5){
  id_OTDIA_30k_5[i-1] <- sum(!is.na(OTDIA_30k_5[, i]))}
```

LIT Turbo DIA auto
```{r}
for(i in 2:5){
id_LITDIA_Turbo_5[i-1] <- sum(!is.na(LITDIA_Turbo_5[, i]))}
```

LIT Rapid DIA
```{r}
for(i in 2:5){
id_LITDIA_Rapid_5[i-1] <- sum(!is.na(LITDIA_Rapid_5[, i]))}
```

LIT Normal DIA
```{r}
for(i in 2:5){
id_LITDIA_Normal_5[i-1] <- sum(!is.na(LITDIA_Normal_5[, i]))}
```

## 10 ng

OT 7.5k DIA
```{r}
for(i in 2:5){
  id_OTDIA_7k_10[i-1] <- sum(!is.na(OTDIA_7k_10[, i]))}
```

OT 15k DIA
```{r}
for(i in 2:5){
  id_OTDIA_15k_10[i-1] <- sum(!is.na(OTDIA_15k_10[, i]))}
```

OT 30k DIA
```{r}
for(i in 2:5){
  id_OTDIA_30k_10[i-1] <- sum(!is.na(OTDIA_30k_10[, i]))}
```

LIT Turbo DIA auto
```{r}
for(i in 2:5){
id_LITDIA_Turbo_10[i-1] <- sum(!is.na(LITDIA_Turbo_10[, i]))}
```

LIT Rapid DIA
```{r}
for(i in 2:5){
id_LITDIA_Rapid_10[i-1] <- sum(!is.na(LITDIA_Rapid_10[, i]))}
```

LIT Normal DIA
```{r}
for(i in 2:5){
id_LITDIA_Normal_10[i-1] <- sum(!is.na(LITDIA_Normal_10[, i]))}
```

## 100 ng

OT 7.5k DIA
```{r}
for(i in 2:5){
  id_OTDIA_7k_100[i-1] <- sum(!is.na(OTDIA_7k_100[, i]))}
```

OT 15k DIA
```{r}
for(i in 2:5){
  id_OTDIA_15k_100[i-1] <- sum(!is.na(OTDIA_15k_100[, i]))}
```

OT 30k DIA
```{r}
for(i in 2:5){
  id_OTDIA_30k_100[i-1] <- sum(!is.na(OTDIA_30k_100[, i]))}
```

LIT Turbo DIA auto
```{r}
for(i in 2:5){
id_LITDIA_Turbo_100[i-1] <- sum(!is.na(LITDIA_Turbo_100[, i]))}
```

LIT Rapid DIA
```{r}
for(i in 2:5){
id_LITDIA_Rapid_100[i-1] <- sum(!is.na(LITDIA_Rapid_100[, i]))}
```

LIT Normal DIA
```{r}
for(i in 2:5){
id_LITDIA_Normal_100[i-1] <- sum(!is.na(LITDIA_Normal_100[, i]))}
```

## Join

```{r}
id_pep <- data.frame(method = rep(c(rep("OT 7.5k", 4), rep("OT 15k", 4), rep("OT 30k", 4),
                                    rep("LIT Turbo", 4), rep("LIT Rapid", 4), rep("LIT Normal", 4)), 4),
           replicate = rep(1:4, 24),
           id = c(id_OTDIA_7k_1, id_OTDIA_15k_1, id_OTDIA_30k_1, 
                  id_LITDIA_Turbo_1, id_LITDIA_Rapid_1, id_LITDIA_Normal_1,
                  id_OTDIA_7k_5, id_OTDIA_15k_5, id_OTDIA_30k_5, 
                  id_LITDIA_Turbo_5, id_LITDIA_Rapid_5, id_LITDIA_Normal_5,
                  id_OTDIA_7k_10, id_OTDIA_15k_10, id_OTDIA_30k_10, 
                  id_LITDIA_Turbo_10, id_LITDIA_Rapid_10, id_LITDIA_Normal_10,
                  id_OTDIA_7k_100, id_OTDIA_15k_100, id_OTDIA_30k_100, 
                  id_LITDIA_Turbo_100, id_LITDIA_Rapid_100, id_LITDIA_Normal_100),
           input = c(rep("1 ng", 24), rep("5 ng", 24), rep("10 ng", 24), rep("100 ng", 24)))

id_pep$method <- factor(id_pep$method, levels = unique(id_pep$method))
id_pep$input <- factor(id_pep$input, levels = unique(id_pep$input))
```

## plot

```{r}
id_plot <- id_pep %>% 
  group_by(method, input) %>% 
  summarise(mean_id = mean(id),
            sd_id = sd(id))%>%
  ggplot(aes(x = input, y = mean_id, group = method, color = method))+
  theme_bw()+
  geom_line(size = 2.5)+
  geom_point(size = 4)+
  scale_color_manual(values = c("#ADC2E8", "#7F9FDB", "#527DCE", "#EEB9CF", "#DF7FA7", "#D35087"))+
  geom_errorbar(aes(ymin = mean_id - sd_id, 
                         ymax = mean_id + sd_id),
                    width = 0.1,
                    size = 1.5)+
  labs(color = "Methods",
       x = "Input",
       y = "Identified peptides",
       title = "A")+
  theme(legend.position = c(0.23, 0.85),
        legend.background = element_blank(),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.2),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1))

id_plot
```

```{r}
id_pep %>% 
  group_by(method, input) %>% 
  summarise(mean_id = mean(id),
            sd_id = sd(id))%>%
  ggplot(aes(x = input, y = mean_id, fill = method))+
  geom_col(position = position_dodge())+
  scale_fill_manual(values = c("#EEB9CF", "#DF7FA7", "#D35087", "#ADC2E8", "#7F9FDB", "#527DCE"))+
  geom_errorbar(aes(ymin = mean_id - sd_id,
                    ymax = mean_id + sd_id),
                width = 0.7,
                size = 0.5,
                position = position_dodge(0.9))+
  labs(fill = "Methods",
       x = "Input",
       y = "Identified peptides")+
  theme(legend.position = c(0.15, 0.74),
        legend.background = element_blank())
```

 

## Stacked plot

```{r}
compute_CV <- function(x){
  y <- x %>% 
    mutate(sd = apply(x[, 2:(ncol(x)-2)],
                      FUN = sd, MARGIN =  1, na.rm = TRUE),
           CV = sd/mean_quantity)
  colnames(y)[2:(ncol(x)-2)] <- paste0("S", 1:(ncol(x)-3))
  if(ncol(x) <= 6){
  y$S4 <- NA
 }
  return(y)
}
```

### 1 ng

LIT
```{r}
LITDIA_Turbo_1_CV <- compute_CV(LITDIA_Turbo_1)
LITDIA_Turbo_1_CV$method <- "LIT Turbo"
LITDIA_Turbo_1_CV$input<- "1 ng"

LITDIA_Rapid_1_CV <- compute_CV(LITDIA_Rapid_1)
LITDIA_Rapid_1_CV$method <- "LIT Rapid"
LITDIA_Rapid_1_CV$input<- "1 ng"

LITDIA_Normal_1_CV <- compute_CV(LITDIA_Normal_1)
LITDIA_Normal_1_CV$method <- "LIT Normal"
LITDIA_Normal_1_CV$input<- "1 ng"
```

OT
```{r}
OTDIA_7k_1_CV <- compute_CV(OTDIA_7k_1)
OTDIA_7k_1_CV$method <- "OT 7k"
OTDIA_7k_1_CV$input<- "1 ng"

OTDIA_15k_1_CV <- compute_CV(OTDIA_15k_1)
OTDIA_15k_1_CV$method <- "OT 15k"
OTDIA_15k_1_CV$input<- "1 ng"

OTDIA_30k_1_CV <- compute_CV(OTDIA_30k_1)
OTDIA_30k_1_CV$method <- "OT 30k"
OTDIA_30k_1_CV$input<- "1 ng"
```

### 5 ng

LIT
```{r}
LITDIA_Turbo_5_CV <- compute_CV(LITDIA_Turbo_5)
LITDIA_Turbo_5_CV$method <- "LIT Turbo"
LITDIA_Turbo_5_CV$input<- "5 ng"

LITDIA_Rapid_5_CV <- compute_CV(LITDIA_Rapid_5)
LITDIA_Rapid_5_CV$method <- "LIT Rapid"
LITDIA_Rapid_5_CV$input<- "5 ng"

LITDIA_Normal_5_CV <- compute_CV(LITDIA_Normal_5)
LITDIA_Normal_5_CV$method <- "LIT Normal"
LITDIA_Normal_5_CV$input<- "5 ng"
```

OT
```{r}
OTDIA_7k_5_CV <- compute_CV(OTDIA_7k_5)
OTDIA_7k_5_CV$method <- "OT 7k"
OTDIA_7k_5_CV$input<- "5 ng"

OTDIA_15k_5_CV <- compute_CV(OTDIA_15k_5)
OTDIA_15k_5_CV$method <- "OT 15k"
OTDIA_15k_5_CV$input<- "5 ng"

OTDIA_30k_5_CV <- compute_CV(OTDIA_30k_5)
OTDIA_30k_5_CV$method <- "OT 30k"
OTDIA_30k_5_CV$input<- "5 ng"
```

### 10 ng

LIT
```{r}
LITDIA_Turbo_10_CV <- compute_CV(LITDIA_Turbo_10)
LITDIA_Turbo_10_CV$method <- "LIT Turbo"
LITDIA_Turbo_10_CV$input<- "10 ng"

LITDIA_Rapid_10_CV <- compute_CV(LITDIA_Rapid_10)
LITDIA_Rapid_10_CV$method <- "LIT Rapid"
LITDIA_Rapid_10_CV$input<- "10 ng"

LITDIA_Normal_10_CV <- compute_CV(LITDIA_Normal_10)
LITDIA_Normal_10_CV$method <- "LIT Normal"
LITDIA_Normal_10_CV$input<- "10 ng"
```

OT
```{r}
OTDIA_7k_10_CV <- compute_CV(OTDIA_7k_10)
OTDIA_7k_10_CV$method <- "OT 7k"
OTDIA_7k_10_CV$input<- "10 ng"

OTDIA_15k_10_CV <- compute_CV(OTDIA_15k_10)
OTDIA_15k_10_CV$method <- "OT 15k"
OTDIA_15k_10_CV$input<- "10 ng"

OTDIA_30k_10_CV <- compute_CV(OTDIA_30k_10)
OTDIA_30k_10_CV$method <- "OT 30k"
OTDIA_30k_10_CV$input<- "10 ng"
```

### 100 ng

LIT
```{r}
LITDIA_Turbo_100_CV <- compute_CV(LITDIA_Turbo_100)
LITDIA_Turbo_100_CV$method <- "LIT Turbo"
LITDIA_Turbo_100_CV$input<- "100 ng"

LITDIA_Rapid_100_CV <- compute_CV(LITDIA_Rapid_100)
LITDIA_Rapid_100_CV$method <- "LIT Rapid"
LITDIA_Rapid_100_CV$input<- "100 ng"

LITDIA_Normal_100_CV <- compute_CV(LITDIA_Normal_100)
LITDIA_Normal_100_CV$method <- "LIT Normal"
LITDIA_Normal_100_CV$input<- "100 ng"
```

OT
```{r}
OTDIA_7k_100_CV <- compute_CV(OTDIA_7k_100)
OTDIA_7k_100_CV$method <- "OT 7k"
OTDIA_7k_100_CV$input<- "100 ng"

OTDIA_15k_100_CV <- compute_CV(OTDIA_15k_100)
OTDIA_15k_100_CV$method <- "OT 15k"
OTDIA_15k_100_CV$input<- "100 ng"

OTDIA_30k_100_CV <- compute_CV(OTDIA_30k_100)
OTDIA_30k_100_CV$method <- "OT 30k"
OTDIA_30k_100_CV$input<- "100 ng"
```

### Join and count id

```{r}
CV_joined <- 
  rbind(LITDIA_Turbo_1_CV, LITDIA_Rapid_1_CV, LITDIA_Normal_1_CV,
      OTDIA_7k_1_CV, OTDIA_15k_1_CV, OTDIA_30k_1_CV,
      LITDIA_Turbo_5_CV, LITDIA_Rapid_5_CV, LITDIA_Normal_5_CV,
      OTDIA_7k_5_CV, OTDIA_15k_5_CV, OTDIA_30k_5_CV,
      LITDIA_Turbo_10_CV, LITDIA_Rapid_10_CV, LITDIA_Normal_10_CV,
      OTDIA_7k_10_CV, OTDIA_15k_10_CV, OTDIA_30k_10_CV,
      LITDIA_Turbo_100_CV, LITDIA_Rapid_100_CV, LITDIA_Normal_100_CV,
      OTDIA_7k_100_CV, OTDIA_15k_100_CV, OTDIA_30k_100_CV)
CV_joined$method %>% table()
CV_joined$input %>% table()

CV_joined$method <- factor(CV_joined$method, 
                          levels = unique(CV_joined$method))

CV_joined$input <- factor(CV_joined$input, 
                          levels = unique(CV_joined$input))

CV_joined$CV_filter <- NA

CV_joined$CV_filter[CV_joined$CV < 0.1] <- "3"
CV_joined$CV_filter[CV_joined$CV >= 0.1 & CV_joined$CV <= 0.15] <- "2"
CV_joined$CV_filter[CV_joined$CV > 0.15] <- "1"

CV_joined <- CV_joined %>%
  filter(!is.na(CV_filter)) %>% 
  group_by(method, input, CV_filter) %>% 
  summarise(id_S1 = sum(!is.na(S1)),
            id_S2 = sum(!is.na(S2)),
            id_S3 = sum(!is.na(S3)),
            id_S4 = sum(!is.na(S4)))

CV_joined$mean_id <- rowMeans(CV_joined[4:7], na.rm = TRUE)
CV_joined$sd_id <- apply(CV_joined[4:7], FUN =  sd, MARGIN = 1, na.rm = TRUE)
```

### plot 

```{r}
CV_joined$y_errorbar <- CV_joined$mean_id
CV_joined$y_errorbar[CV_joined$CV_filter == "1"] <- 
  CV_joined$y_errorbar[CV_joined$CV_filter == "1"] +
  CV_joined$y_errorbar[CV_joined$CV_filter == "2"]+
  CV_joined$y_errorbar[CV_joined$CV_filter == "3"]

CV_joined$y_errorbar[CV_joined$CV_filter == "2"] <-
  CV_joined$y_errorbar[CV_joined$CV_filter == "2"]+
  CV_joined$y_errorbar[CV_joined$CV_filter == "3"]

stacked_plot <- CV_joined %>% 
  ggplot(aes(x = input, y = mean_id, fill = CV_filter))+
  geom_col(width = 0.7) +
  facet_wrap(~method) +
  labs(x = "Input",
       y = "Identidied peptides",
       fill = "CV",
       title = "B") +
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        axis.title.y = element_text(vjust = 2.2),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        legend.key.size = unit(0.9, "cm"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.08),
        plot.margin = margin(l = 25),
        legend.position = c(0.1, 0.285),
        legend.background = element_blank())+
  scale_fill_manual(values = c("grey82", "#ff9090", "#ff3030"),
                    labels = c("\U2265 15%", "10 - 15%", "< 10%" ))+
  scale_y_continuous(limits = c(0, 18000))+
  geom_errorbar(aes(ymin = y_errorbar - sd_id, 
                         ymax = y_errorbar + sd_id),
                    width = 0.2,
                    size = 1)

 
cairo_pdf(filename = "fig1_id.pdf", width = 14.6, height = 7.81)
stacked_plot 
dev.off()
```


# Figure 1

```{r}
temp <- id_plot +  stacked_plot + plot_layout(widths = c(1, 2))
temp2 <- plot_spacer() + corr_plot + plot_spacer() + plot_layout(widths = c(1, 10, 1))
temp3 <- plot_spacer() + OT_in_LIT_plot + plot_spacer() + plot_layout(widths = c(1, 10, 1))
fig1 <- temp/temp2/temp3 + plot_layout(heights = c(0.8, 1, 1))

cairo_pdf(filename = "fig1.pdf", width = 20.83, height = 27.08)
fig1
dev.off()
```


# Windowing scheme

## Load data

### 1 ng

```{r}
#34w
LITDIA_Normal_34w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_1ng_40SPD_whisper100_1CV_auto_34w.csv"))
#45w
LITDIA_Normal_45w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_1ng_40SPD_whisper100_1CV_auto_45w.csv"))
```

### 100 ng

```{r}
#34w
LITDIA_Normal_34w_100 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_100ng_40SPD_whisper100_1CV_auto_34w.csv"))
#45w
LITDIA_Normal_45w_100 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_100ng_40SPD_whisper100_1CV_auto_45w.csv"))
```

## Remove peptides found in less than 3 replicates

### 1 ng

```{r}
LITDIA_Normal_34w_1 <-  filter_pep(LITDIA_Normal_34w_1)
LITDIA_Normal_34w_1_filter <- LITDIA_Normal_34w_1[LITDIA_Normal_34w_1$filtered == FALSE, ]
LITDIA_Normal_45w_1 <-  filter_pep(LITDIA_Normal_45w_1)
LITDIA_Normal_45w_1_filter <- LITDIA_Normal_45w_1[LITDIA_Normal_45w_1$filtered == FALSE, ]
```



### 100 ng

```{r}
LITDIA_Normal_34w_100 <-  filter_pep(LITDIA_Normal_34w_100)
LITDIA_Normal_34w_100_filter <- LITDIA_Normal_34w_100[LITDIA_Normal_34w_100$filtered == FALSE, ]
LITDIA_Normal_45w_100 <-  filter_pep(LITDIA_Normal_45w_100)
LITDIA_Normal_45w_100_filter <- LITDIA_Normal_45w_100[LITDIA_Normal_45w_100$filtered == FALSE, ]
```

## id

```{r}
id_LITDIA_Normal_34w_1 <- id_LITDIA_Normal_45w_1 <- 
  id_LITDIA_Normal_34w_100 <- id_LITDIA_Normal_45w_100 <- rep(NA, 4)
```

### 1 ng

34w
```{r}
for(i in 2:5){
  id_LITDIA_Normal_34w_1[i-1] <- sum(!is.na(LITDIA_Normal_34w_1[, i]))}
```

45w
```{r}
for(i in 2:5){
  id_LITDIA_Normal_45w_1[i-1] <- sum(!is.na(LITDIA_Normal_45w_1[, i]))}
```

### 100 ng

34w
```{r}
for(i in 2:5){
  id_LITDIA_Normal_34w_100[i-1] <- sum(!is.na(LITDIA_Normal_34w_100[, i]))}
```

45w
```{r}
for(i in 2:5){
  id_LITDIA_Normal_45w_100[i-1] <- sum(!is.na(LITDIA_Normal_45w_100[, i]))}
```

### Join

```{r}
id_win <- data.frame(method = rep(c(rep("34w", 4), rep("40w", 4),
                                    rep("45w", 4)),2),
           replicate = rep(1:4, 6),
           id = c(id_LITDIA_Normal_34w_1, id_LITDIA_Normal_1, id_LITDIA_Normal_45w_1,
                  id_LITDIA_Normal_34w_100, id_LITDIA_Normal_100, id_LITDIA_Normal_45w_100),
           input = c(rep("1 ng", 12), rep("100 ng", 12)))

id_win$method <- factor(id_win$method, levels = unique(id_win$method))
id_win$input <- factor(id_win$input, levels = unique(id_win$input))
```

### plot

```{r}
id_win_plot <- id_win %>% 
  group_by(method, input) %>% 
  summarise(mean_id = mean(id),
            sd_id = sd(id))%>%
  ggplot(aes(x = method, y = mean_id, group = input, color = input))+
  theme_classic2()+
  geom_line(size = 2.5)+
  geom_point(size = 4)+
  scale_color_manual(values = c("#EAACC6","#D35087"))+
  scale_y_continuous(limits = c(3200, 12000))+
  geom_errorbar(aes(ymin = mean_id - sd_id, 
                         ymax = mean_id + sd_id),
                    width = 0.08,
                    size = 1)+
  labs(color = "Input",
       x = "Windowing scheme",
       y = "Identified peptides",
       title = "A")+
  theme(legend.position = c(0.23, 0.95),
        legend.background = element_blank(),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.2))

id_win_plot
```

## CV

## Compute CV

### 1 ng

LITDIA Normal 34w
```{r}
LITDIA_Normal_34w_1_CV <- LITDIA_Normal_34w_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "34w",
         input = "1 ng")
```

LITDIA Normal 45w
```{r}
LITDIA_Normal_45w_1_CV <- LITDIA_Normal_45w_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "45w",
         input = "1 ng")
```

### 100 ng

LITDIA Normal 34w
```{r}
LITDIA_Normal_34w_100_CV <- LITDIA_Normal_34w_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "34w",
         input = "100 ng")
```

LITDIA Normal 45w
```{r}
LITDIA_Normal_45w_100_CV <- LITDIA_Normal_45w_100[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "45w",
         input = "100 ng")
```

### Join

```{r}
CV_win_joined <- 
  rbind(LITDIA_Normal_34w_1_CV, LITDIA_Normal_1_CV, LITDIA_Normal_45w_1_CV,
        LITDIA_Normal_34w_100_CV, LITDIA_Normal_100_CV, LITDIA_Normal_45w_100_CV)

CV_win_joined$input <- factor(CV_win_joined$input, levels = unique(CV_win_joined$input))
```


### Plot

```{r}
CV_win_joined$method <- factor(CV_win_joined$method, levels = unique(CV_win_joined$method))
CV_win_joined$indiv <- paste(CV_win_joined$method, CV_win_joined$input, sep = " ")

levels(CV_win_joined$method)

lim <- 
  c(boxplot.stats(log10(CV_win_joined[CV_win_joined$method ==
                                    "34w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_win_joined[CV_win_joined$method ==
                                    "LITDIA_Normal",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_win_joined[CV_win_joined$method ==
                                    "45w",]$CV*100))$stats[c(1,5)])
lim <- c(min(lim), max(lim))

CV_win_plot <- CV_win_joined %>% 
  ggplot(aes(x = input, 
             y = CV*100, 
             fill = as.factor(indiv)))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9)+
  scale_fill_manual(values = rep(c("#EAACC6","#D35087"),3)) +
  scale_y_log10(breaks = c(1, 10, 20, 100),
                limits = c(0.08, 190))+
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(x = "Input",
       y = "CV (%)",
       title = "B")+
  theme(legend.position = "none",
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.08),
        panel.grid = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1),
        strip.text.x = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"))+
  facet_wrap(~method, labeller = labeller(method = 
                                            c("34w" = "34w",
                                              "LITDIA_Normal" = "40w",
                                              "45w" = "45w"))) +
  coord_cartesian(ylim = 10^(lim))
CV_win_plot
```

# Figure 2

```{r}
fig2 <- id_win_plot + CV_win_plot + plot_layout(widths = c(1, 2))
```


# Points across peak

## Load data

## violin plot

### 1 ng

```{r}
pp_Turbo_40SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Turbo_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_1$indiv <- "Turbo_40SPD_1_"

pp_Rapid_40SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_1$indiv <- "Rapid_40SPD_1_"

pp_Normal_40SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_1$indiv <- "Normal_40SPD_1_"

pp_Rapid_20SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_1$indiv <- "Rapid_20SPD_1_"

pp_Normal_20SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_1$indiv <- "Normal_20SPD_1_"

pp_Enhanced_20SPD_1 <- read.csv2(paste0(pp_path, "PPP_LIT_Enhanced_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_1$indiv <- "Enhanced_20SPD_1_"
```

### 5 ng

```{r}
pp_Turbo_40SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Turbo_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_5$indiv <- "Turbo_40SPD_5_"

pp_Rapid_40SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_5$indiv <- "Rapid_40SPD_5_"

pp_Normal_40SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_5$indiv <- "Normal_40SPD_5_"

pp_Rapid_20SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_5$indiv <- "Rapid_20SPD_5_"

pp_Normal_20SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_5$indiv <- "Normal_20SPD_5_"

pp_Enhanced_20SPD_5 <- read.csv2(paste0(pp_path, "PPP_LIT_Enhanced_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_5$indiv <- "Enhanced_20SPD_5_"
```

### 10 ng

```{r}
pp_Turbo_40SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Turbo_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_10$indiv <- "Turbo_40SPD_10_"

pp_Rapid_40SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_10$indiv <- "Rapid_40SPD_10_"

pp_Normal_40SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_10$indiv <- "Normal_40SPD_10_"

pp_Rapid_20SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_10$indiv <- "Rapid_20SPD_10_"

pp_Normal_20SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_10$indiv <- "Normal_20SPD_10_"

pp_Enhanced_20SPD_10 <- read.csv2(paste0(pp_path, "PPP_LIT_Enhanced_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_10$indiv <- "Enhanced_20SPD_10_"
```


### 100 ng

```{r}
pp_Turbo_40SPD_100 <- read.csv2(paste0(pp_path, "PPP_LIT_Turbo_DIA_100ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_100$indiv <- "Turbo_40SPD_100_"

pp_Rapid_40SPD_100 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_100ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_100$indiv <- "Rapid_40SPD_100_"

pp_Normal_40SPD_100 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_100ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_100$indiv <- "Normal_40SPD_100_"

pp_Rapid_20SPD_100 <- read.csv2(paste0(pp_path, "PPP_LIT_Rapid_DIA_100ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_100$indiv <- "Rapid_20SPD_100_"

pp_Normal_20SPD_100 <- read.csv2(paste0(pp_path, "PPP_LIT_Normal_DIA_100ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_100$indiv <- "Normal_20SPD_100_"
```

### Join

```{r}
colnames(pp_Turbo_40SPD_1) <- colnames(pp_Turbo_40SPD_5) <- colnames(pp_Turbo_40SPD_10) <-
  colnames(pp_Turbo_40SPD_100) <- colnames(pp_Rapid_40SPD_1) <- colnames(pp_Rapid_40SPD_5) <-
  colnames(pp_Rapid_40SPD_10) <- colnames(pp_Rapid_40SPD_100) <- colnames(pp_Normal_40SPD_1) <-
  colnames(pp_Normal_40SPD_5) <- colnames(pp_Normal_40SPD_10) <- colnames(pp_Normal_40SPD_100) <-
  colnames(pp_Rapid_20SPD_1) <- colnames(pp_Rapid_20SPD_5) <- colnames(pp_Rapid_20SPD_10) <-
  colnames(pp_Rapid_20SPD_100) <- colnames(pp_Normal_20SPD_1) <- colnames(pp_Normal_20SPD_5) <-
  colnames(pp_Normal_20SPD_10) <- colnames(pp_Normal_20SPD_100) <- colnames(pp_Enhanced_20SPD_1) <-
  colnames(pp_Enhanced_20SPD_5) <- colnames(pp_Enhanced_20SPD_10) <-
  c("Points_per_Peaks", "indiv")
# 

pp <- rbind(pp_Turbo_40SPD_1, pp_Turbo_40SPD_5, pp_Turbo_40SPD_10, pp_Turbo_40SPD_100,
            pp_Rapid_40SPD_1, pp_Rapid_40SPD_5, pp_Rapid_40SPD_10, pp_Rapid_40SPD_100,
            pp_Normal_40SPD_1, pp_Normal_40SPD_5, pp_Normal_40SPD_10, pp_Normal_40SPD_100,
            pp_Rapid_20SPD_1, pp_Rapid_20SPD_5, pp_Rapid_20SPD_10, pp_Rapid_20SPD_100, 
            pp_Normal_20SPD_1, pp_Normal_20SPD_5, pp_Normal_20SPD_10, pp_Normal_20SPD_100,
            pp_Enhanced_20SPD_1, pp_Enhanced_20SPD_5, pp_Enhanced_20SPD_10)

pp$input <- NA
pp$input[grepl("1_", pp$indiv)] <- "1 ng"
pp$input[grepl("5_", pp$indiv)] <- "5 ng"
pp$input[grepl("10_", pp$indiv)] <- "10 ng"
pp$input[grepl("100_", pp$indiv)] <- "100 ng"
pp$input <- factor(pp$input, levels = unique(pp$input))

pp$IT <- NA
pp$IT[grepl("20SPD", pp$indiv)] <- "20 SPD"
pp$IT[grepl("40SPD", pp$indiv)] <- "40 SPD"
pp$IT <- factor(pp$IT, levels = c("40 SPD", "20 SPD"))

pp$method <- NA
pp$method[grepl("Turbo", pp$indiv)] <- "Turbo"
pp$method[grepl("Rapid", pp$indiv)] <- "Rapid"
pp$method[grepl("Normal", pp$indiv)] <- "Normal"
pp$method[grepl("Enhanced", pp$indiv)] <- "Enhanced"
pp$method <- factor(pp$method, levels = c("Turbo", "Rapid", "Normal", "Enhanced"))

```

### plot 

```{r}
palette1 <-c("#C8F5FF", "#75CFFF", "#B3E4FF") 

plot_40SPD <- pp %>%
  filter(IT == "40 SPD" &
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = Points_per_Peaks,
             fill = as.factor(indiv)))+
  scale_y_log10()+
  geom_violin(draw_quantiles = 0.5) +
  scale_fill_manual(values = rep(palette1,3)) +
  facet_grid(IT ~ method)+
  geom_hline(yintercept = 6,
             linetype = "dashed") +
  labs(title = "A")+
  theme(legend.position = "none",
        axis.text = element_text(size = 24),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 20,  
                             r = 50,
                             b = 20,
                             l = 10),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.1))

palette2 <- c("#00E5E6", "#009999", "#00CCCC") 

plot_20SPD <- pp %>%
  filter(IT == "20 SPD" &
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = Points_per_Peaks,
             fill = as.factor(indiv)))+
  geom_violin(draw_quantiles = 0.5)+
  scale_y_log10() +
  scale_fill_manual(values = rep(palette2,3)) +
  facet_grid(IT ~ method) +
  geom_hline(yintercept = 6,
             linetype = "dashed") +
  labs(x = "Input",
       y = "Points across a peak") +
  theme(legend.position = "none",
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 15,  
                             r = 50,
                             b = 10,
                             l = 10))

limit <- 10^c(min(c(layer_scales(plot_40SPD)$y$get_limits(), 
                   layer_scales(plot_20SPD)$y$get_limits())),
              max(c(layer_scales(plot_40SPD)$y$get_limits(),
                   layer_scales(plot_20SPD)$y$get_limits())))

pp_plot <- (plot_40SPD + 
    scale_y_log10(limits = limit,
                   breaks = c(3, 6, 10, 30))+
    theme(axis.title = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()))/
  (plot_20SPD + 
     scale_y_log10(limits = limit,
                   breaks = c(3, 6, 10, 30))+
     theme(axis.title.y = element_text(hjust = -1.8, vjust = 1)))
pp_plot
```

## Total number of precursors

```{r}
id_prec_40SPD <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_prec = sum(!is.na(Points_per_Peaks))) %>% 
  filter(IT == "40 SPD" &
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = n_prec/4, group = method, color = method)) +
  geom_line(size = 2.5) +
  geom_point(size = 4) +
  theme_classic2() +
  scale_color_manual(values = c("#d3c582FF", "#6FB382FF", "#92BBD9FF"))+
  labs(color = "Scanning method",
       x = "Input",
       title = "B")+
  theme(legend.position = c(0.148, 0.85),
        legend.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        axis.title.y = element_blank(),
        plot.margin = margin(t = 0,  
                             r = 58,
                             b = 54,
                             l = 10),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.37))+  
  annotate("text", x = 3.5, y = 7500, label = "40 SPD", angle = -90, size = 9.5)

id_prec_20SPD <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_prec = sum(!is.na(Points_per_Peaks))) %>% 
  filter(IT == "20 SPD"&
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = n_prec/4, group = method, color = method)) +
  geom_line(size = 2.5) +
  geom_point(size = 4) +
  theme_classic2() +
  scale_color_manual(values = c("#6FB382FF", "#92BBD9FF", "#4D6D93FF")) +
  labs(color = "Scanning method",
       x = "Input",
       y = "Total precursors number")+
  theme(legend.position = c(0.18, 0.85),
        legend.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        axis.title.y = element_text(hjust = 0.2,
                                    vjust = 2.4),
        plot.margin = margin(t = 15,
                             r = 58,
                             b = 40,
                             l = 10),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1))+  
  annotate("text", x = 3.5, y = 7500, label = "20 SPD", angle = -90, size = 9.5)

limit <- c(min(c(layer_scales(id_prec_40SPD)$y$get_limits(), 
                 layer_scales(id_prec_20SPD)$y$get_limits())),
max(c(layer_scales(id_prec_40SPD)$y$get_limits(), layer_scales(id_prec_20SPD)$y$get_limits())))

id_prec <- (id_prec_40SPD +
             scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500))+
            theme(axis.title.x = element_blank(),
                  axis.text.x = element_blank()))/ 
(id_prec_20SPD +
   scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500)))
```

## PPP >= 6

```{r}
pp$acc <- pp$Points_per_Peaks >= 6

id_acc_40SPD <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_acc = sum(acc)) %>% 
  filter(IT == "40 SPD" &
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = n_acc/4, group = method, color = method)) +
  geom_line(size = 2.5) +
  geom_point(size = 4) +
  theme_classic2() +
  scale_color_manual(values = c("#d3c582FF", "#6FB382FF", "#92BBD9FF"))+
  labs(color = "Scanning method",
       x = "Input",
       title = "B")+
  theme(legend.position = c(0.148, 0.85),
        legend.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        axis.title.y = element_blank(),
        plot.margin = margin(t = 0,  
                             r = 58,
                             b = 54,
                             l = 10),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.37))+  
  annotate("text", x = 3.5, y = 7500, label = "40 SPD", angle = -90, size = 9.5)

id_acc_20SPD <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_acc = sum(acc)) %>% 
  filter(IT == "20 SPD"&
           input != "100 ng") %>% 
  ggplot(aes(x = input, y = n_acc/4, group = method, color = method)) +
  geom_line(size = 2.5) +
  geom_point(size = 4) +
  theme_classic2() +
  scale_color_manual(values = c("#6FB382FF", "#92BBD9FF", "#4D6D93FF")) +
  labs(color = "Scanning method",
       x = "Input",
       y = "Precursors with points across a peak >= 6")+
  theme(legend.position = c(0.18, 0.85),
        legend.background = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 22),
        axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        legend.key.size = unit(0.9, "cm"),
        axis.title.y = element_text(hjust = 0.2,
                                    vjust = 2.4),
        plot.margin = margin(t = 15,
                             r = 58,
                             b = 40,
                             l = 10),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1))+  
  annotate("text", x = 3.5, y = 7500, label = "20 SPD", angle = -90, size = 9.5)

limit <- c(min(c(layer_scales(id_acc_40SPD)$y$get_limits(), 
                 layer_scales(id_acc_20SPD)$y$get_limits())),
max(c(layer_scales(id_acc_40SPD)$y$get_limits(), layer_scales(id_acc_20SPD)$y$get_limits())))

id_acc <- (id_acc_40SPD +
             scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500))+
            theme(axis.title.x = element_blank(),
                  axis.text.x = element_blank()))/ 
(id_acc_20SPD +
   scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500)))
```

```{r}
wrap_plots(id_prec,id_acc)
```

```{r}
temp1 <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_prec = sum(!is.na(Points_per_Peaks)))

temp2 <- pp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_acc = sum(acc))

temp1$Precursors <- "< 6"
temp2$Precursors <- "\U2265 6"

colnames(temp1)[5] <- "n"
colnames(temp2)[5] <- "n"

temp1$n <- temp1$n - temp2$n

temp <- rbind(temp2, temp1)

temp$Precursors <- factor(temp$Precursors, 
                         levels = c("< 6", "\U2265 6"))


id_pr_40SPD <- temp %>% 
  filter(input != "100 ng" & IT == "40 SPD" ) %>% 
  ggplot(aes(x = method, y = n/4, fill = Precursors, group = method)) +
  geom_col() +
  theme_bw() +
  facet_grid(IT ~ input) +
  labs(x = "Scanning mode",
       y = "Precursors number",
       title = "B",
       fill = "Points across a peak")+
  scale_fill_manual(values = c("grey82", "#ff3030"))+
  theme(plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.095),
        axis.title = element_blank(),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        legend.title = element_text(size = 27, vjust = 1.3),
        legend.text = element_text(size = 22),
        legend.position = "top")

id_pr_20SPD <- temp %>% 
  filter(input != "100 ng" & IT == "20 SPD" ) %>% 
  ggplot(aes(x = method , y = n/4, fill = Precursors, group = method)) +
  geom_col() +
  theme_bw() +
  facet_grid(IT ~ input) +
  labs(x = "Scanning mode",
       y = "Precursors number")+
  scale_fill_manual(values = c("grey82", "#ff3030"))+
  theme(axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background.x = element_blank(),
        strip.background = element_rect(fill = "#E5E4F7"),
        strip.text.x = element_blank(),
        axis.title.x = element_text(vjust = -1),
        legend.position = "none")

limit <- c(min(c(layer_scales(id_pr_40SPD)$y$get_limits(),
                 layer_scales(id_pr_20SPD)$y$get_limits())),
           max(c(layer_scales(id_pr_40SPD)$y$get_limits(),
                 layer_scales(id_pr_20SPD)$y$get_limits()))+500)

id_pr_plot <-
 (id_pr_40SPD +
    theme(axis.title = element_blank())+
    scale_y_continuous(limits = limit))/
 (id_pr_20SPD +
    theme(axis.title.y = element_text(hjust = -2.15,
                                      vjust = 3.5))+
    scale_y_continuous(limits = limit))
```



## Figure 4

```{r}
id_acc <- (id_acc_40SPD +
             scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500))+
            theme(axis.title.x = element_blank(),
                  axis.text.x = element_blank()))/ 
(id_acc_20SPD +
   scale_y_continuous(limits = limit, breaks = c(2500, 7500, 12500)))

wrap_plots(pp_plot, id_acc)+ plot_layout(widths = c(1.7, 1))
```

```{r}
temp <- wrap_plots(pp_plot,id_pr_plot, nrow = 2)

cairo_pdf(filename = "fig6.pdf", width = 16.67, height = 18.75,)
temp 
dev.off()
```


# Windowing scheme and injection time

## Load data

40 SPD
```{r}
#38ms 34w
LITDIA_Rapid_40SPD_23ms_40w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Rapid_DIA_1ng_40SPD_whisper100_1CV_auto_34w.csv"))

#31ms 34w
LITDIA_Rapid_40SPD_31ms_34w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Rapid_DIA_1ng_40SPD_whisper100_1CV_31ms_34w.csv"))

#31ms 25w
LITDIA_Rapid_40SPD_31ms_25w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Rapid_DIA_1ng_40SPD_whisper100_1CV_31ms_25w.csv"))

#30ms 30w
LITDIA_Rapid_40SPD_30ms_30w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Rapid_DIA_1ng_40SPD_whisper100_1CV_30ms_30w.csv"))
```

20 SPD
```{r}
#76ms 20w
LITDIA_Normal_20SPD_76ms_20w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV_76ms_20w.csv"))

#50ms 30w
LITDIA_Normal_20SPD_50ms_30w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV_50ms_30w.csv"))

#38ms 40w
LITDIA_Normal_20SPD_38ms_40w_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV_38ms_40w.csv"))
```

## Remove peptides found in less than 3 replicates

40 SPD
```{r}
LITDIA_Rapid_40SPD_23ms_40w_1 <- filter_pep(LITDIA_Rapid_40SPD_23ms_40w_1)
LITDIA_Rapid_40SPD_31ms_34w_1 <- filter_pep(LITDIA_Rapid_40SPD_31ms_34w_1)
LITDIA_Rapid_40SPD_31ms_25w_1 <- filter_pep(LITDIA_Rapid_40SPD_31ms_25w_1)
LITDIA_Rapid_40SPD_30ms_30w_1 <- filter_pep(LITDIA_Rapid_40SPD_30ms_30w_1)
```

20 SPD
```{r}
LITDIA_Normal_20SPD_76ms_20w_1 <- filter_pep(LITDIA_Normal_20SPD_76ms_20w_1)
LITDIA_Normal_20SPD_50ms_30w_1 <- filter_pep(LITDIA_Normal_20SPD_50ms_30w_1)
LITDIA_Normal_20SPD_38ms_40w_1 <- filter_pep(LITDIA_Normal_20SPD_38ms_40w_1)
```

## id

```{r}
id_LITDIA_Rapid_40SPD_23ms_40w_1 <- id_LITDIA_Rapid_40SPD_31ms_34w_1 <- 
  id_LITDIA_Rapid_40SPD_31ms_25w_1 <- id_LITDIA_Rapid_40SPD_30ms_30w_1 <-
  id_LITDIA_Normal_20SPD_76ms_20w_1 <- id_LITDIA_Normal_20SPD_50ms_30w_1 <-
  id_LITDIA_Normal_20SPD_38ms_40w_1 <- rep(NA, 4)
```

### 40 SPD

38ms 34w
```{r}
for(i in 2:(ncol(LITDIA_Rapid_40SPD_23ms_40w_1)-2)){
  id_LITDIA_Rapid_40SPD_23ms_40w_1[i-1] <- sum(!is.na(LITDIA_Rapid_40SPD_23ms_40w_1[, i]))}
```
31ms 34w
```{r}
for(i in 2:(ncol(LITDIA_Rapid_40SPD_31ms_34w_1)-2)){
  id_LITDIA_Rapid_40SPD_31ms_34w_1[i-1] <- sum(!is.na(LITDIA_Rapid_40SPD_31ms_34w_1[, i]))}
```
31ms 25w
```{r}
for(i in 2:(ncol(LITDIA_Rapid_40SPD_31ms_25w_1)-2)){
  id_LITDIA_Rapid_40SPD_31ms_25w_1[i-1] <- sum(!is.na(LITDIA_Rapid_40SPD_31ms_25w_1[, i]))}
```

30ms 30w
```{r}
for(i in 2:(ncol(LITDIA_Rapid_40SPD_30ms_30w_1)-2)){
  id_LITDIA_Rapid_40SPD_30ms_30w_1[i-1] <- sum(!is.na(LITDIA_Rapid_40SPD_30ms_30w_1[, i]))}
```

### 20 SPD

76ms 20w
```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_76ms_20w_1)-2)){
  id_LITDIA_Normal_20SPD_76ms_20w_1[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_76ms_20w_1[, i]))}
```

50ms 30w
```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_50ms_30w_1)-2)){
  id_LITDIA_Normal_20SPD_50ms_30w_1[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_50ms_30w_1[, i]))}
```

38ms 40w
```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_38ms_40w_1)-2)){
  id_LITDIA_Normal_20SPD_38ms_40w_1[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_38ms_40w_1[, i]))}
```

### Join

```{r}
id_it <- 
  data.frame(IT = c(rep("23ms", 4), rep("31ms", 4), rep("31ms", 4), rep("30ms", 4),
                    rep("76ms", 4), rep("50ms", 4), rep("38ms", 4)),
             windows = c(rep("40w", 4), rep("34w", 4), rep("25w", 4), rep("30w", 4),
                         rep("20w", 4), rep("30w", 4), rep("40w", 4)),
             SPD = c(rep("40 SPD", 16), rep("20 SPD", 12)),
             replicate = rep(1:4, 7),
             id = c(id_LITDIA_Rapid_40SPD_23ms_40w_1, id_LITDIA_Rapid_40SPD_31ms_34w_1,
                    id_LITDIA_Rapid_40SPD_31ms_25w_1, id_LITDIA_Rapid_40SPD_30ms_30w_1,
                    id_LITDIA_Normal_20SPD_76ms_20w_1, id_LITDIA_Normal_20SPD_50ms_30w_1,
                    id_LITDIA_Normal_20SPD_38ms_40w_1))
id_it$method <- paste(id_it$IT, id_it$windows, sep = " ")
```

### plot

```{r}
id_it_plot_40SPD <- id_it %>% 
  filter(SPD == "40 SPD" &
           method != "31ms 34w") %>% 
  group_by(method, SPD) %>% 
  summarise(mean_id = mean(id, na.rm = TRUE),
            sd_id = sd(id, na.rm = TRUE)) %>%
  ggplot(aes(x = method, y = mean_id))+
  geom_col(position = position_dodge(),
           width = 0.7,
           fill = "#B3E4FF")+
  scale_x_discrete(labels = c("23ms 40w" = "  23ms
40w",
                              "30ms 30w" = "  30ms
30w",
                              "31ms 25w" = "  31ms
25w"))+
  facet_grid(~SPD)+
  geom_errorbar(aes(ymin = mean_id - sd_id, 
                         ymax = mean_id + sd_id),
                    width = 0.2,
                    size = 1)+
  labs(x = "Method",
       y = "Identidied peptides",
       title = "A")+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        panel.grid = element_blank(),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.35),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 3.4))

id_it_plot_20SPD <- id_it %>% 
  filter(SPD == "20 SPD") %>% 
  group_by(method, SPD) %>% 
  summarise(mean_id = mean(id, na.rm = TRUE),
            sd_id = sd(id, na.rm = TRUE)) %>%
  ggplot(aes(x = method, y = mean_id))+
  geom_col(position = position_dodge(),
           width = 0.7,
           fill = "#00CCCC")+
  scale_x_discrete(labels = c("38ms 40w" = "  38ms
40w",
                              "50ms 30w" = "  50ms
30w",
                              "76ms 20w" = "  76ms
20w"))+
  facet_grid(~SPD)+
  geom_errorbar(aes(ymin = mean_id - sd_id, 
                         ymax = mean_id + sd_id),
                    width = 0.2,
                    size = 1)+
  labs(x = "Method",
       y = "Identified peptides")+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        panel.grid = element_blank(),
        axis.text.x = element_text(hjust = 0.62),
        plot.margin = margin(t = 20,
                             r = 50,
                             b = 40,
                             l = 15))

limit <- c(min(c(layer_scales(id_it_plot_40SPD)$y$get_limits(),
                 layer_scales(id_it_plot_20SPD)$y$get_limits())),
           max(c(layer_scales(id_it_plot_40SPD)$y$get_limits(),
                 layer_scales(id_it_plot_20SPD)$y$get_limits()))+500)

id_it_plot <- 
  (((id_it_plot_40SPD + 
    scale_y_continuous(limits = limit) +
     theme(axis.title.x = element_blank())) +
  (id_it_plot_20SPD + 
     scale_y_continuous(limits = limit) +
    theme(axis.title.x = element_text(hjust = -0.2),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank(),
          axis.title.y = element_blank()))))
id_it_plot
```

## CV

### 40 SPD

LITDIA_Rapid_40SPD_23ms_40w
```{r}
LITDIA_Rapid_40SPD_23ms_40w_1_CV <- LITDIA_Rapid_40SPD_23ms_40w_1[,1:4] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid_40SPD_23ms_40w",
         SPD = "40 SPD")
```

LITDIA_Rapid_40SPD_31ms_34w_1
```{r}
LITDIA_Rapid_40SPD_31ms_34w_1_CV <- LITDIA_Rapid_40SPD_31ms_34w_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid_40SPD_31ms_34w",
         SPD = "40 SPD")
```

LITDIA_Rapid_40SPD_31ms_25w_1
```{r}
LITDIA_Rapid_40SPD_31ms_25w_1_CV <- LITDIA_Rapid_40SPD_31ms_25w_1[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid_40SPD_31ms_25w",
         SPD = "40 SPD")
```

LITDIA_Rapid_40SPD_30ms_30w_1
```{r}
LITDIA_Rapid_40SPD_30ms_30w_1_CV <- LITDIA_Rapid_40SPD_30ms_30w_1[,1:4] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Rapid_40SPD_30ms_30w",
         SPD = "40 SPD")
```

### 20 SPD

LITDIA_Normal_20SPD_76ms_20w_1
```{r}
LITDIA_Normal_20SPD_76ms_20w_1_CV <- LITDIA_Normal_20SPD_76ms_20w_1[,1:4] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_76ms_20w",
         SPD = "20 SPD")
```

LITDIA_Normal_20SPD_50ms_30w_1
```{r}
LITDIA_Normal_20SPD_50ms_30w_1_CV <- LITDIA_Normal_20SPD_50ms_30w_1[,1:4] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_50ms_30w",
         SPD = "20 SPD")
```

LITDIA_Normal_20SPD_38ms_40w_1
```{r}
LITDIA_Normal_20SPD_38ms_40w_1_CV <- LITDIA_Normal_20SPD_38ms_40w_1[,1:4] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_38ms_40w",
         SPD = "20 SPD")
```

### Join

```{r}
CV_it_joined <- 
  rbind(LITDIA_Rapid_40SPD_23ms_40w_1_CV, LITDIA_Rapid_40SPD_30ms_30w_1_CV, 
        LITDIA_Rapid_40SPD_31ms_34w_1_CV, LITDIA_Rapid_40SPD_31ms_25w_1_CV,
        LITDIA_Normal_20SPD_38ms_40w_1_CV, LITDIA_Normal_20SPD_50ms_30w_1_CV,
        LITDIA_Normal_20SPD_76ms_20w_1_CV)
CV_it_joined$method %>% table()
```

### Plot

```{r}
nimp <- "nimp"
CV_it_joined$method <- factor(CV_it_joined$method, levels = unique(CV_it_joined$method))
CV_it_joined$SPD <- factor(CV_it_joined$SPD, levels = unique(CV_it_joined$SPD))
CV_it_joined$method %>% table()

lim <- 
  c(boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Rapid_40SPD_23ms_40w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Rapid_40SPD_30ms_30w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Rapid_40SPD_31ms_25w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Normal_20SPD_38ms_40w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Normal_20SPD_50ms_30w",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_it_joined[CV_it_joined$method ==
                                     "LITDIA_Normal_20SPD_76ms_20w",]$CV*100))$stats[c(1,5)])
lim <- c(min(lim), max(lim))  

CV_it_40SPD_plot <- CV_it_joined %>%
  filter(method != "LITDIA_Rapid_40SPD_31ms_34w" &
           SPD == "40 SPD") %>% 
  ggplot(aes(x = nimp, 
             y = CV*100))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9,
               fill = "#B3E4FF") +
  facet_grid(SPD ~ method,
             labeller = labeller(method = 
                                   c("LITDIA_Rapid_40SPD_23ms_40w" = "23ms 40w",
                                     "LITDIA_Rapid_40SPD_30ms_30w" = "30ms 30w",
                                     "LITDIA_Rapid_40SPD_31ms_25w" = "31ms 25w"))) +
  scale_y_log10()+
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(y = "CV (%)",
       title = "B")+
  theme(legend.position = "none",
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.14),
        panel.grid = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"))+
  coord_cartesian(ylim = 10^(lim))

CV_it_20SPD_plot <- CV_it_joined %>%
  filter(SPD == "20 SPD") %>% 
  ggplot(aes(x = nimp, 
             y = CV*100))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9,
               fill = "#00CCCC") +
  facet_grid(SPD ~ method,
             labeller = labeller(method = 
                                   c("LITDIA_Normal_20SPD_38ms_40w" = "38ms 40w",
                                     "LITDIA_Normal_20SPD_50ms_30w" = "50ms 30w",
                                     "LITDIA_Normal_20SPD_76ms_20w" = "76ms 20w"))) +
  scale_y_log10()+
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(y = "CV (%)")+
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"))+
  coord_cartesian(ylim = 10^(lim))

CV_it_plot <-
 (CV_it_40SPD_plot +
    scale_y_log10(breaks = c(1, 20, 100))+
    theme(axis.title.y = element_blank()))/
 (CV_it_20SPD_plot + 
    scale_y_log10(breaks = c(1, 20, 100))+
    theme(axis.title.y = element_text(hjust = 1.62,
                                      vjust = 2.3)))
```

## Stacked plot

### 40 SPD

```{r}
LITDIA_Rapid_40SPD_23ms_40w_1_CV <- compute_CV(LITDIA_Rapid_40SPD_23ms_40w_1)
LITDIA_Rapid_40SPD_23ms_40w_1_CV$method <- "23ms_40w"
LITDIA_Rapid_40SPD_23ms_40w_1_CV$SPD <- "40 SPD"

LITDIA_Rapid_40SPD_31ms_34w_1_CV <- compute_CV(LITDIA_Rapid_40SPD_31ms_34w_1)
LITDIA_Rapid_40SPD_31ms_34w_1_CV$method <- "31ms_34w"
LITDIA_Rapid_40SPD_31ms_34w_1_CV$SPD <- "40 SPD"

LITDIA_Rapid_40SPD_31ms_25w_1_CV <- compute_CV(LITDIA_Rapid_40SPD_31ms_25w_1)
LITDIA_Rapid_40SPD_31ms_25w_1_CV$method <- "31ms_25w"
LITDIA_Rapid_40SPD_31ms_25w_1_CV$SPD <- "40 SPD"

LITDIA_Rapid_40SPD_30ms_30w_1_CV <- compute_CV(LITDIA_Rapid_40SPD_30ms_30w_1)
LITDIA_Rapid_40SPD_30ms_30w_1_CV$method <- "30ms_30w"
LITDIA_Rapid_40SPD_30ms_30w_1_CV$SPD <- "40 SPD"
```

### 20 SPD

```{r}
LITDIA_Normal_20SPD_76ms_20w_1_CV <- compute_CV(LITDIA_Normal_20SPD_76ms_20w_1)
LITDIA_Normal_20SPD_76ms_20w_1_CV$method <- "76ms_20w"
LITDIA_Normal_20SPD_76ms_20w_1_CV$SPD <- "20 SPD"

LITDIA_Normal_20SPD_50ms_30w_1_CV <- compute_CV(LITDIA_Normal_20SPD_50ms_30w_1)
LITDIA_Normal_20SPD_50ms_30w_1_CV$method <- "50ms_30w"
LITDIA_Normal_20SPD_50ms_30w_1_CV$SPD <- "20 SPD"

LITDIA_Normal_20SPD_38ms_40w_1_CV <- compute_CV(LITDIA_Normal_20SPD_38ms_40w_1)
LITDIA_Normal_20SPD_38ms_40w_1_CV$method <- "38ms_40w"
LITDIA_Normal_20SPD_38ms_40w_1_CV$SPD <- "20 SPD"
```

### Join and count id

```{r}
CV_it_joined <- 
  rbind(LITDIA_Rapid_40SPD_23ms_40w_1_CV, LITDIA_Rapid_40SPD_30ms_30w_1_CV, 
        LITDIA_Rapid_40SPD_31ms_34w_1_CV, LITDIA_Rapid_40SPD_31ms_25w_1_CV,
        LITDIA_Normal_20SPD_38ms_40w_1_CV, LITDIA_Normal_20SPD_50ms_30w_1_CV,
        LITDIA_Normal_20SPD_76ms_20w_1_CV)
CV_it_joined$method %>% table()

CV_it_joined$CV_filter <- CV_it_joined$CV <= 0.2

CV_it_joined <- CV_it_joined %>%
  filter(!is.na(CV_filter)) %>% 
  group_by(method, CV_filter, SPD) %>% 
  summarise(id_S1 = sum(!is.na(S1)),
            id_S2 = sum(!is.na(S2)),
            id_S3 = sum(!is.na(S3)),
            id_S4 = sum(!is.na(S4)))
CV_it_joined$id_S4[CV_it_joined$id_S4 == 0] <- NA
CV_it_joined$mean_id <- rowMeans(CV_it_joined[4:7], na.rm = TRUE)
CV_it_joined$sd_id <- apply(CV_it_joined[4:7], FUN =  sd, MARGIN = 1, na.rm = TRUE)
```

### plot 

```{r}
CV_it_joined$y_errorbar <- CV_it_joined$mean_id
CV_it_joined$y_errorbar[CV_it_joined$CV_filter == FALSE] <- 
  CV_it_joined$y_errorbar[CV_it_joined$CV_filter == FALSE] +
  CV_it_joined$y_errorbar[CV_it_joined$CV_filter == TRUE]

id_filter_plot_40SPD <- CV_it_joined %>% 
  filter(method != "31ms_34w" &
           SPD == "40 SPD") %>% 
  ggplot(aes(x = method, y = mean_id, fill = CV_filter))+
  geom_col(width = 0.7)+
  scale_x_discrete(labels = c("23ms_40w" = "  23ms
40w",
                              "30ms_30w" = "  30ms
30w",
                              "31ms_25w" = "  31ms
25w"))+
  facet_grid(~SPD)+
  labs(x = "Method",
       y = "Identidied peptides",
       fill = "CV < 20%")+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        panel.grid = element_blank(),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 3.4))+
  scale_fill_manual(values = c("grey82", "#ff3030"))+
  geom_errorbar(aes(ymin = y_errorbar - sd_id, 
                         ymax = y_errorbar + sd_id),
                    width = 0.2,
                    size = 1)

id_filter_plot_20SPD <- CV_it_joined %>% 
  filter(SPD == "20 SPD") %>% 
  ggplot(aes(x = method, y = mean_id, fill = CV_filter))+
  geom_col(width = 0.7)+
  scale_x_discrete(labels = c("38ms_40w" = "  38ms
40w",
                              "50ms_30w" = "  50ms
30w",
                              "76ms_20w" = "  76ms
20w"))+
  facet_grid(~SPD)+
  labs(x = "Injection Time & Number of Windows",
       y = "Identidied peptides",
       fill = "CV")+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        panel.grid = element_blank(),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        legend.key.size = unit(0.9, "cm"),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 3.4))+
  scale_fill_manual(values = c("grey82", "#ff3030"),
                    labels = c("> 20%", "< or = 20%"))+
  geom_errorbar(aes(ymin = y_errorbar - sd_id, 
                         ymax = y_errorbar + sd_id),
                    width = 0.2,
                    size = 1)
```

```{r}
limit <- c(min(c(layer_scales(id_filter_plot_40SPD)$y$get_limits(),
                 layer_scales(id_filter_plot_20SPD)$y$get_limits())),
           max(c(layer_scales(id_filter_plot_40SPD)$y$get_limits(),
                 layer_scales(id_filter_plot_20SPD)$y$get_limits()))+500)

id_filter_plot <- 
  (((id_filter_plot_40SPD + 
    scale_y_continuous(limits = limit) +
     theme(axis.title.x = element_blank(),
           legend.position = 'none')) +
  (id_filter_plot_20SPD + 
     scale_y_continuous(limits = limit) +
    theme(axis.title.x = element_text(hjust = 2.5, vjust = -1),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank(),
          axis.title.y = element_blank()))))

id_filter_plot
```


## Figure 3

```{r}
wrap_plots(id_it_plot, CV_it_plot)
```

# Tables

```{r}
method_details <- 
  read.csv("C:/Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/Table/method_table.csv")
colnames(method_details) <- c("Mass Analyzer", "Scanning Mode", "Injection Time (ms)", "Overhead (ms)",
                              "Cycle Time (s)", "Windowing Scheme (m/z)")
method_details[2:7,] <- method_details[1:6,]
method_details[6:8,] <- method_details[5:7,]
method_details[1, ] <- colnames(method_details)
method_details[5, ] <- colnames(method_details)
method_details[5, 2] <- "Resolution"
colnames(method_details) <- NULL

method_details[, -4] %>% 
  kable(align = "c") %>%
  kable_classic(font_size = 30) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  row_spec(4, extra_css = "border-bottom: 3px solid") %>% 
  row_spec(1, bold = TRUE, extra_css = "border-bottom: 3px solid") %>% 
  row_spec(5, bold = TRUE, extra_css = "border-bottom: 3px solid") %>% 
  row_spec(c(1:6))
```

```{r}
fig_details <- read.csv("C:/Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/Table/Table.csv")

colnames(fig_details) <- NULL

#table 2.1
fig_details[1:26,]  %>% 
  kable(caption = "<center><strong>Table 2.1</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid") %>%
  row_spec(14, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")


#table 2.2
temp <- fig_details[27:33,]
rownames(temp) <- NULL
temp %>% 
  kable(caption = "<center><strong>Table 2.2</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")

#table 2.3
temp <- fig_details[34:40,]
rownames(temp) <- NULL
temp %>% 
  kable(caption = "<center><strong>Table 2.3</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")

#table 2.4
temp <- fig_details[41:45,]
rownames(temp) <- NULL
temp %>% 
  kable(caption = "<center><strong>Table 2.4</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")

#table 2.5
temp <- fig_details[46:67,]
rownames(temp) <- NULL
temp %>% 
  kable(caption = "<center><strong>Table 2.5</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")

#table 2.6
temp <- fig_details[68:86,]
rownames(temp) <- NULL
temp %>% 
  kable(caption = "<center><strong>Table 2.6</strong></center>") %>%
  kable_classic(font_size = 18) %>% 
  kable_styling(bootstrap_options = c("striped", "hover")) %>% 
  gsub("font-size: initial !important;",
       "font-size: 18pt !important;", .) %>%
  row_spec(1, bold = TRUE, extra_css = "border-top: 3px solid; border-bottom : 3px solid")
```


# Heatmap

## Join

```{r, message = TRUE}
welcome_to_dk <- 
  Reduce(function(...) merge(..., all = TRUE, by = "PEP.StrippedSequence"),
       list(LITDIA_Turbo_1_filter[,c(1,6)], LITDIA_Turbo_5_filter[,c(1,6)],
            LITDIA_Turbo_10_filter[,c(1,6)], LITDIA_Turbo_100_filter[,c(1,6)],
            LITDIA_Rapid_1_filter[,c(1,6)], LITDIA_Rapid_5_filter[,c(1,6)],
            LITDIA_Rapid_10_filter[,c(1,6)], LITDIA_Rapid_100_filter[,c(1,6)],
            LITDIA_Normal_1_filter[,c(1,6)], LITDIA_Normal_5_filter[,c(1,6)],
            LITDIA_Normal_10_filter[,c(1,6)], LITDIA_Normal_100_filter[,c(1,6)],
            OTDIA_7k_1_filter[,c(1,6)], OTDIA_7k_5_filter[,c(1,6)],
            OTDIA_7k_10_filter[,c(1,6)], OTDIA_7k_100_filter[,c(1,6)],
            OTDIA_15k_1_filter[,c(1,6)], OTDIA_15k_5_filter[,c(1,6)],
            OTDIA_15k_10_filter[,c(1,6)], OTDIA_15k_100_filter[,c(1,6)],
            OTDIA_30k_1_filter[,c(1,6)], OTDIA_30k_5_filter[,c(1,6)],
            OTDIA_30k_10_filter[,c(1,6)], OTDIA_30k_100_filter[,c(1,6)]))

colnames(welcome_to_dk)[-1] <- 
  c("LIT Turbo 1 ng", "LIT Turbo 5 ng", "LIT Turbo 10 ng", "LIT Turbo 100 ng",
    "LIT Rapid 1 ng", "LIT Rapid 5 ng", "LIT Rapid 10 ng", "LIT Rapid 100 ng",
    "LIT Normal 1 ng", "LIT Normal 5 ng", "LIT Normal 10 ng", "LIT Normal 100 ng",
    "OT 7k 1 ng", "OT 7k 5 ng", "OT 7k 10 ng", "OT 7k 100 ng",
    "OT 15k 1 ng", "OT 15k 5 ng", "OT 15k 10 ng", "OT 15k 100 ng",
    "OT 30k 1 ng", "OT 30k 5 ng", "OT 30k 10 ng", "OT 30k 100 ng")

head(welcome_to_dk)
```

## Heatmap

```{r}
welcome_to_dk[, -1] <- apply(welcome_to_dk[, -1], 2, log10)

cormat <- cor(welcome_to_dk[, -1], use = "complete.obs")


cormat2 <- cormat[grep("LIT", rownames(cormat)), grep("OT", colnames(cormat))]
pheatmap(cormat2[c(1, 5, 9), c(1, 5, 9)], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
pheatmap(cormat2[c(2, 6, 10), c(2, 6, 10)], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
pheatmap(cormat2[c(3, 7, 11), c(3, 7, 11)], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
pheatmap(cormat2[c(4, 8, 12), c(4, 8, 12)], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)

pheatmap(cormat[-c(grep("100", rownames(cormat)), 22, 5), 
                -c(grep("100", colnames(cormat)), 22, 5)], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)

pheatmap(cormat[-grep("100", rownames(cormat)), 
                -grep("100", colnames(cormat))], 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)


pheatmap(cormat, 
         cluster_rows = FALSE, 
         cluster_cols = FALSE)
```


# IT

## Load data


```{r}
LITDIA_Normal_20SPD_60ms <- read.csv2(paste0(lit_path, "20220215_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV45_60ms.csv"))

LITDIA_Normal_20SPD_80ms <- read.csv2(paste0(lit_path, "20220215_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV45_80ms.csv"))

LITDIA_Normal_20SPD_100ms <- read.csv2(paste0(lit_path, "20220215_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV45_100ms.csv"))

LITDIA_Normal_20SPD_38ms <- read.csv2(paste0(lit_path, "20220525_LIT_Normal_DIA_1ng_20SPD_whisper100_1CV45_auto.csv"))
```


## Remove peptides found in less than 3 replicates

```{r}
LITDIA_Normal_20SPD_60ms <- filter_pep(LITDIA_Normal_20SPD_60ms)
LITDIA_Normal_20SPD_80ms <- filter_pep(LITDIA_Normal_20SPD_80ms)
LITDIA_Normal_20SPD_100ms <- filter_pep(LITDIA_Normal_20SPD_100ms)
LITDIA_Normal_20SPD_38ms <- filter_pep(LITDIA_Normal_20SPD_38ms)
```

## id

```{r}
id_LITDIA_Normal_20SPD_60ms <- id_LITDIA_Normal_20SPD_80ms <- 
  id_LITDIA_Normal_20SPD_100ms <- id_LITDIA_Normal_20SPD_38ms <-
  rep(NA, 4)
```

```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_60ms)-2)){
  id_LITDIA_Normal_20SPD_60ms[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_60ms[, i]))}
```

```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_80ms)-2)){
  id_LITDIA_Normal_20SPD_80ms[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_80ms[, i]))}
```

```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_100ms)-2)){
  id_LITDIA_Normal_20SPD_100ms[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_100ms[, i]))}
```

```{r}
for(i in 2:(ncol(LITDIA_Normal_20SPD_38ms)-2)){
  id_LITDIA_Normal_20SPD_38ms[i-1] <- sum(!is.na(LITDIA_Normal_20SPD_38ms[, i]))}
```

### Join

```{r}
id_IT <- 
  data.frame(IT = c(rep("38 ms", 4), rep("60 ms", 4), rep("80 ms", 4), rep("100 ms", 4)),
             replicate = rep(1:4, 4),
             id = c(id_LITDIA_Normal_20SPD_38ms, id_LITDIA_Normal_20SPD_60ms,
                    id_LITDIA_Normal_20SPD_80ms, id_LITDIA_Normal_20SPD_100ms),
             SPD = rep("20 SPD   Normal   1 ng", 4))
id_IT$IT <- factor(id_IT$IT, levels = unique(id_IT$IT))
```

### plot

```{r}
id_IT_plot <- id_IT %>% 
  group_by(IT, SPD) %>% 
  summarise(mean_id = mean(id, na.rm = TRUE),
            sd_id = sd(id, na.rm = TRUE)) %>%
  ggplot(aes(x = IT, y = mean_id))+
  geom_col(position = position_dodge(),
           width = 0.7,
           fill = "#00CCCC")+
  geom_errorbar(aes(ymin = mean_id - sd_id, 
                         ymax = mean_id + sd_id),
                    width = 0.2,
                    size = 1)+
  facet_grid(~SPD) +
  scale_y_continuous(limits = c(0, 7700)) +
  labs(x = "Injection Time",
       y = "Identified peptides",
       title = "A")+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        panel.grid = element_blank(),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.2),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 3.4),
        axis.title.x = element_text(vjust = -0.5))
```

## CV

LITDIA_Normal_20SPD_38ms
```{r}
LITDIA_Normal_20SPD_38ms_CV <- LITDIA_Normal_20SPD_38ms[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_38ms")
```

LITDIA_Normal_20SPD_60ms
```{r}
LITDIA_Normal_20SPD_60ms_CV <- LITDIA_Normal_20SPD_60ms[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_60ms")
```

LITDIA_Normal_20SPD_80ms
```{r}
LITDIA_Normal_20SPD_80ms_CV <- LITDIA_Normal_20SPD_80ms[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_80ms")
```

LITDIA_Normal_20SPD_100ms
```{r}
LITDIA_Normal_20SPD_100ms_CV <- LITDIA_Normal_20SPD_100ms[,1:5] %>% 
  pivot_longer(names_to = "Sample", 
               values_to = "Quantity", 
               -PEP.StrippedSequence) %>% 
  group_by(PEP.StrippedSequence) %>% 
  summarise(mean_quantity = mean(Quantity, na.rm = TRUE),
            sd_quantity = sd(Quantity, na.rm = TRUE)) %>% 
  mutate(CV = sd_quantity/mean_quantity,
         method = "LITDIA_Normal_20SPD_100ms")
```

### Join

```{r}
CV_IT_joined <- 
  rbind(LITDIA_Normal_20SPD_38ms_CV, LITDIA_Normal_20SPD_60ms_CV, 
        LITDIA_Normal_20SPD_80ms_CV, LITDIA_Normal_20SPD_100ms_CV)
CV_IT_joined$method %>% table()
```

### Plot

```{r}
CV_IT_joined$method <- factor(CV_IT_joined$method, levels = unique(CV_IT_joined$method))
CV_IT_joined$SPD <- "20 SPD   Normal   1 ng "

lim <- 
  c(boxplot.stats(log10(CV_IT_joined[CV_IT_joined$method ==
                                     "LITDIA_Normal_20SPD_38ms",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_IT_joined[CV_IT_joined$method ==
                                     "LITDIA_Normal_20SPD_60ms",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_IT_joined[CV_IT_joined$method ==
                                     "LITDIA_Normal_20SPD_80ms",]$CV*100))$stats[c(1,5)],
    boxplot.stats(log10(CV_IT_joined[CV_IT_joined$method ==
                                     "LITDIA_Normal_20SPD_100ms",]$CV*100))$stats[c(1,5)])
lim <- c(min(lim), max(lim))  

CV_IT_plot <- CV_IT_joined %>% 
  ggplot(aes(x = method, 
             y = CV*100))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9,
               fill = "#00CCCC") +
  facet_grid(~SPD,
             labeller = labeller()) +
  scale_x_discrete(labels = c("LITDIA_Normal_20SPD_38ms" = "38 ms",
                              "LITDIA_Normal_20SPD_60ms" = "60 ms",
                              "LITDIA_Normal_20SPD_80ms" = "80 ms",
                              "LITDIA_Normal_20SPD_100ms" = "100 ms")) +
  scale_y_log10(breaks = c(1, 20, 100))+
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(y = "CV (%)",
       title = "B",
       x = "Injection Time")+
  theme(legend.position = "none",
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.175),
        panel.grid = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.ticks.x = element_blank(),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 20,
                             r = 50,
                             b = 40,
                             l = 60),
        axis.title.x = element_text(vjust = -0.5)) + 
  coord_cartesian(ylim = 10^(lim))
```

## Stacked plot

```{r}
LITDIA_Normal_20SPD_38ms_CV <- compute_CV(LITDIA_Normal_20SPD_38ms)
LITDIA_Normal_20SPD_38ms_CV$IT <- "38ms"

LITDIA_Normal_20SPD_60ms_CV <- compute_CV(LITDIA_Normal_20SPD_60ms)
LITDIA_Normal_20SPD_60ms_CV$IT <- "60ms"

LITDIA_Normal_20SPD_80ms_CV <- compute_CV(LITDIA_Normal_20SPD_80ms)
LITDIA_Normal_20SPD_80ms_CV$IT <- "80ms"

LITDIA_Normal_20SPD_100ms_CV <- compute_CV(LITDIA_Normal_20SPD_100ms)
LITDIA_Normal_20SPD_100ms_CV$IT <- "100ms"
```

### Join and count id

```{r}
CV_IT_joined <- 
  rbind(LITDIA_Normal_20SPD_38ms_CV, LITDIA_Normal_20SPD_60ms_CV, 
        LITDIA_Normal_20SPD_80ms_CV, LITDIA_Normal_20SPD_100ms_CV)
CV_IT_joined$IT %>% table()
CV_IT_joined$IT <- factor(CV_IT_joined$IT, 
                          levels = c("38ms", "60ms", "80ms", "100ms"))

CV_IT_joined$CV_filter <- NA

CV_IT_joined$CV_filter[CV_IT_joined$CV < 0.1] <- "3"
CV_IT_joined$CV_filter[CV_IT_joined$CV >= 0.1 & CV_IT_joined$CV <= 0.15] <- "2"
CV_IT_joined$CV_filter[CV_IT_joined$CV > 0.15] <- "1"

CV_IT_joined$SPD <- "20 SPD"

CV_IT_joined <- CV_IT_joined %>%
  filter(!is.na(CV_filter)) %>% 
  group_by(SPD, IT, CV_filter) %>% 
  summarise(id_S1 = sum(!is.na(S1)),
            id_S2 = sum(!is.na(S2)),
            id_S3 = sum(!is.na(S3)),
            id_S4 = sum(!is.na(S4)))

CV_IT_joined$mean_id <- rowMeans(CV_IT_joined[4:7], na.rm = TRUE)
CV_IT_joined$sd_id <- apply(CV_IT_joined[4:7], FUN =  sd, MARGIN = 1, na.rm = TRUE)
```

### plot 

```{r}
CV_IT_joined$y_errorbar <- CV_IT_joined$mean_id
CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "1"] <-
  CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "1"] +
  CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "2"]+
  CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "3"]
CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "2"] <-
  CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "2"]+
  CV_IT_joined$y_errorbar[CV_IT_joined$CV_filter == "3"]

IT_stacked_plot <- CV_IT_joined %>% 
  ggplot(aes(x = IT, y = mean_id, fill = CV_filter))+
  geom_col(width = 0.7) +
  facet_grid(~SPD) +
  labs(x = "Injection Time",
       y = "Identidied peptides",
       fill = "CV") +
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 2.2),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        legend.key.size = unit(0.9, "cm"),
        axis.title.x = element_text(vjust = -1),
        plot.margin = margin(b = 20,
                             l = 20))+
  scale_fill_manual(values = c("grey82", "#ff9090", "#ff3030"),
                    labels = c("\U2265 15%", "10 - 15%", "< 10%" ))+
  scale_y_continuous(limits = c(0, 8000)) +
  geom_errorbar(aes(ymin = y_errorbar - sd_id, 
                         ymax = y_errorbar + sd_id),
                    width = 0.2,
                    size = 1)

IT_stacked_plot

cairo_pdf(filename = "fig4.pdf", width = 9.9, height = 8.65)
IT_stacked_plot
dev.off()
```

```{r}
limit <- c(min(c(layer_scales(id_filter_plot_40SPD)$y$get_limits(),
                 layer_scales(id_filter_plot_20SPD)$y$get_limits())),
           max(c(layer_scales(id_filter_plot_40SPD)$y$get_limits(),
                 layer_scales(id_filter_plot_20SPD)$y$get_limits()))+500)

id_filter_plot <- 
  (((id_filter_plot_40SPD + 
    scale_y_continuous(limits = limit) +
     theme(axis.title.x = element_blank(),
           legend.position = 'none')) +
  (id_filter_plot_20SPD + 
     scale_y_continuous(limits = limit) +
    theme(axis.title.x = element_text(hjust = 2.5, vjust = -1),
           axis.text.y = element_blank(),
           axis.ticks.y = element_blank(),
          axis.title.y = element_blank()))))

id_filter_plot
```

## Fig

```{r}
id_IT_plot + CV_IT_plot
```

# Circle area

```{r}
table_path <- "C:/Users/samgr/OneDrive - UCL/Documents/Internship/Data/LITDIA/Table/"
```


```{r}
idk <- read.csv(paste0(table_path, "table_lit.csv"))
idk <- idk[, c(8,9, 10)] 
idk$inv_median_CV <- 1/idk$median_CV
max <- 
  data.frame(pep_id = max(idk$pep_id) + (max(idk$pep_id)- min(idk$pep_id))/4, 
             inv_median_CV = max(idk$inv_median_CV) + (max(idk$inv_median_CV)- min(idk$inv_median_CV))/4,
             median_ppp = max(idk$median_ppp) + (max(idk$median_ppp)- min(idk$median_ppp))/4)

min <- 
  data.frame(pep_id = min(idk$pep_id) - (max(idk$pep_id)- min(idk$pep_id))/4, 
             inv_median_CV = min(idk$inv_median_CV) - (max(idk$inv_median_CV)- min(idk$inv_median_CV))/4,
             median_ppp = min(idk$median_ppp) - (max(idk$median_ppp)- min(idk$median_ppp))/4)

d <- rbind(max, min, idk[, -2])

radarchart(d,
            pfcol = c("#405D6140", "#06425A40", "#59051440"),
            pcol = c("#405D61", "#06425A", "#590514"),
           cglty = 1)

legend("topright",
       legend = c("Turbo", "Rapid", "Normal"),
       bty = "n", pch = 20, col = c("#405D61", "#06425A", "#590514"),
       text.col = "grey25", pt.cex = 2)
```


# Clinical

## Load data

```{r}
LITDIA_Enhanced_20SPD_DVP_188 <- read.csv2(paste0(lit_path, "190141_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_188.csv"))

LITDIA_Enhanced_20SPD_DVP_375 <- read.csv2(paste0(lit_path, "190203_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_375.csv"))

LITDIA_Enhanced_20SPD_DVP_750 <- read.csv2(paste0(lit_path, "190111_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_750.csv"))

LITDIA_Enhanced_20SPD_DVP_1500 <- read.csv2(paste0(lit_path, "190043_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_1500.csv"))

LITDIA_Enhanced_20SPD_DVP_3000 <- read.csv2(paste0(lit_path, "190018_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_3000.csv"))

LITDIA_Enhanced_20SPD_DVP_6000 <- read.csv2(paste0(lit_path, "190226_HB_TP_Evo_Whisper100_20SPD_LITDIA_1CV-45_Enhanced_auto_DVP_6000.csv"))
```

```{r}
grep("P37023", LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions)

accession <- LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions[grep("Q13123|P62826|P02751|P42226|P07766|P20963|P06127|P11836|P01732|P15391", LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions)]

#CD19 P15391
#CD8A P01732
#CD20 P11836
#CD5 P06127
#CD3Z P20963
#CD3E P07766
#IK Q13123
#ran P62826
#FN-1 P02751
#STAT-6 P42226
```

```{r}
grep("P37023", LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions)

accession <- LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions[grep("P20963|P07766|P15391", LITDIA_Enhanced_20SPD_DVP_750$PG.ProteinAccessions)]

#CD19 P15391
#CD8A P01732
#CD20 P11836
#CD5 P06127
#CD3Z P20963
#CD3E P07766
#IK Q13123
#ran P62826
#FN-1 P02751
#STAT-6 P42226
```

## Rank plot

```{r}
filter_pep2 <- function(x) {
  x$FG.Quantity[as.logical(x$EG.IsImputed)] <- NA
  y <- x %>% 
  group_by(R.FileName, PEP.StrippedSequence, PG.ProteinGroups) %>% 
  summarise(mean_quantity = mean(FG.Quantity, na.rm = TRUE)) %>%  
  pivot_wider(names_from = R.FileName, 
              values_from = mean_quantity) %>%
    suppressMessages()
  z <- y %>% 
    as.data.frame() %>% 
  mutate(na_nbr = rowSums(is.na(y[-c(1:2)]))) %>%
  mutate(mean_quantity = rowMeans(y[3:ncol(y)], na.rm = TRUE)) %>%
  mutate(filtered = !na_nbr <= 1) %>% 
  select(-na_nbr) %>% 
  suppressMessages("`summarise()` has grouped output by 'R.FileName'. You can override using the `.groups` argument.")
  message("
Highlighted ", sum(z$filtered) , " peptide(s) found in less than ", ncol(y) -2, " replicates")
  
  return(z)
}
```




```{r}
LITDIA_Enhanced_20SPD_DVP_750_1 <- filter_pep2(LITDIA_Enhanced_20SPD_DVP_750)
```

```{r}
a <- LITDIA_Enhanced_20SPD_DVP_750_1 %>% 
  group_by(PG.ProteinGroups) %>%
  summarise(prot_quantity = median(mean_quantity))


temp <- a %>%
  arrange(desc(prot_quantity)) %>% 
  mutate(rank = as.numeric(as.factor(desc(prot_quantity))),
         marker = PG.ProteinGroups %in% accession)
temp$marker %>% table()

mark <- temp[temp$marker == TRUE,]
mark$prot <- c("CD3E", "CD19", "CD3Z")

rank_plot <- ggplot()+
  geom_point(data = temp, 
                 aes(x = rank, 
                 y = prot_quantity,
                 color =  !marker),
             size = 3)+
  scale_color_manual(values = c("#FF2020", "grey10"),
                     labels = c("Lymphocytes markers", "Other proteins"))+
  geom_point(data = temp[temp$marker == TRUE,],
             aes(x = rank, 
                 y = prot_quantity),
             color = "#FF2020",
             size = 3.5)+
  labs(x = "Abundance rank",
       y = "LFQ intensity",
       color = "Proteins")+
  scale_y_log10()+
  theme(axis.text = element_text(size = 24),
        axis.title = element_text(size = 27),
        axis.text.x = element_text(hjust = 0.62),
        axis.title.y = element_text(vjust = 2.2),
        legend.title = element_text(size = 27),
        legend.text = element_text(size = 22),
        legend.key.size = unit(0.9, "cm"),
        axis.title.x = element_text(vjust = -1),
        plot.margin = margin(b = 20,
                             l = 20))+
  geom_label_repel(data = mark,
            aes(x = rank, y = prot_quantity, 
                label = prot),
            direction = "y",
            nudge_y = 0.25,
            size = 6)

cairo_pdf(filename = "fig8_V3.pdf", width = 12.5, height = 6.77)
rank_plot
dev.off()
```

## Proteins

```{r}
cl <- rbind(LITDIA_Enhanced_20SPD_DVP_188, LITDIA_Enhanced_20SPD_DVP_375,
      LITDIA_Enhanced_20SPD_DVP_750, LITDIA_Enhanced_20SPD_DVP_1500,
      LITDIA_Enhanced_20SPD_DVP_3000, LITDIA_Enhanced_20SPD_DVP_6000)

  prot_id <- cl %>%  
    group_by(PG.ProteinGroups, R.FileName, R.Replicate) %>%
    summarise(mean_quantity = mean(FG.Quantity)) %>% 
    group_by(R.FileName, R.Replicate) %>% 
    summarise(prots = n()) %>% 
  pivot_wider(names_from = R.FileName, values_from = prots) %>% 
  as.data.frame() %>% 
  mutate(mean_prot_id = apply(.[,-1], FUN = mean, MARGIN = 1, na.rm = TRUE),
         sd_prot_id = apply(.[,-1], FUN = sd, MARGIN = 1, na.rm = TRUE),
         surface_area = as.numeric(sub(".*DVP_", "", R.FileName))*70)

```

# 20 SPD Enhanced

```{r}
LITDIA_Enhanced_20SPD_1 <- read.csv2(paste0(lit_path, "20220509_LIT_Enhanced_DIA_1ng_20SPD_whisper100_1CV_auto.csv"))

LITDIA_Enhanced_20SPD_5 <- read.csv2(paste0(lit_path, "20220509_LIT_Enhanced_DIA_5ng_20SPD_whisper100_1CV_auto.csv"))

LITDIA_Enhanced_20SPD_10 <- read.csv2(paste0(lit_path, "20220509_LIT_Enhanced_DIA_10ng_20SPD_whisper100_1CV_auto.csv"))
```


```{r}
LITDIA_Enhanced_20SPD_1_cv <- LITDIA_Enhanced_20SPD_1 %>% 
  filter_pep() %>% 
  compute_CV()
LITDIA_Enhanced_20SPD_1_cv$input <- "1 ng"

LITDIA_Enhanced_20SPD_5_cv <- LITDIA_Enhanced_20SPD_5 %>% 
  filter_pep() %>% 
  compute_CV()
LITDIA_Enhanced_20SPD_5_cv$input <- "5 ng"

LITDIA_Enhanced_20SPD_10_cv <- LITDIA_Enhanced_20SPD_10 %>% 
  filter_pep() %>% 
  compute_CV()
LITDIA_Enhanced_20SPD_10_cv$input <- "10 ng"
```

```{r}
Enhanced_cv <-
  rbind(LITDIA_Enhanced_20SPD_1_cv,
        LITDIA_Enhanced_20SPD_5_cv,
        LITDIA_Enhanced_20SPD_10_cv)

Enhanced_cv$input <- factor(Enhanced_cv$input, 
                               levels = unique(Enhanced_cv$input))
```

```{r}
Enhanced_cv %>% 
  ggplot(aes(x = input, 
             y = CV*100))+
  geom_boxplot(outlier.shape = NA,
               color = "black",
               size = 0.9,
               fill = "#00CCCC")+
  geom_hline(yintercept = 20,
             linetype = "dashed",
             size = 0.8)+
  labs(y = "CV (%)",
       title = "B",
       x = "Input")+
  theme(legend.position = "none",
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.175),
        panel.grid = element_blank(),
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.ticks.x = element_blank(),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 20,
                             r = 50,
                             b = 40,
                             l = 60),
        axis.title.x = element_text(vjust = -0.5))+
  coord_cartesian(ylim = c(0, 40))
```


# Note

# Bin

```{r}
temp <- read.csv2(paste0(lit_path, "ppp_test.csv"))
temp$R.Data.Points.per.Peak..MS2..EXT. %>% table()
```


