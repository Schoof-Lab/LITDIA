---
title: "Fig. 5 Improvement of the Number of Points Across Chromatographic Peaks"
autor: "Samuel Gr√©goire & Lukas R. Woltereck"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cerulean
    highlight: kate
    fig_width: 9
    fig_height : 7
    df_print: paged
    number_sections: true
    fig_crop: no
---

Distribution of numbers of points across a peak by using Whisper100TM 20 SPD with DIA-LIT-based methods on Rapid, Normal, and Enhanced scanning modes and Whisper100TM 40 SPD with DIA-LIT-based methods on Turbo, Rapid, and Normal scanning modes on 1, 5, and 10 ng input material.

# Load packages

```{r, message=FALSE}
library("tidyverse")
library("patchwork")

#set bw theme as default theme
theme_set(theme_bw())
```

The path to every folder used is stored to keep everything compact. PPP data is stored in the folder located in pp_path. To reproduce analysis the path must be changed to corresponding path on the local computer.

```{r}
ppp_path <- "C://data/ppp"
```

# Figure A

Distribution of numbers of points across a peak by using Whisper100TM 20 SPD with DIA-LIT-based methods on Rapid, Normal, and Enhanced scanning modes and Whisper100TM 40 SPD with DIA-LIT-based methods on Turbo, Rapid, and Normal scanning modes on 1, 5, and 10 ng input material.

## Load data A

The data containing the number of points across the peak are exported separately from Spectronaut as tsv files. They are loaded in RStudio with the function `read.csv2()`.
Annotations regarding the origin file are included.

1 ng
```{r}
pp_Turbo_40SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Turbo_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_1$indiv <- "Turbo_40SPD_1_"

pp_Rapid_40SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_1$indiv <- "Rapid_40SPD_1_"

pp_Normal_40SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_1ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_1$indiv <- "Normal_40SPD_1_"

pp_Rapid_20SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_1$indiv <- "Rapid_20SPD_1_"

pp_Normal_20SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_1$indiv <- "Normal_20SPD_1_"

pp_Enhanced_20SPD_1 <- read.csv2(paste0(ppp_path, "PPP_LIT_Enhanced_DIA_1ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_1$indiv <- "Enhanced_20SPD_1_"
```

5 ng
```{r}
pp_Turbo_40SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Turbo_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_5$indiv <- "Turbo_40SPD_5_"

pp_Rapid_40SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_5$indiv <- "Rapid_40SPD_5_"

pp_Normal_40SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_5ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_5$indiv <- "Normal_40SPD_5_"

pp_Rapid_20SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_5$indiv <- "Rapid_20SPD_5_"

pp_Normal_20SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_5$indiv <- "Normal_20SPD_5_"

pp_Enhanced_20SPD_5 <- read.csv2(paste0(ppp_path, "PPP_LIT_Enhanced_DIA_5ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_5$indiv <- "Enhanced_20SPD_5_"
```

10 ng
```{r}
pp_Turbo_40SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Turbo_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Turbo_40SPD_10$indiv <- "Turbo_40SPD_10_"

pp_Rapid_40SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Rapid_40SPD_10$indiv <- "Rapid_40SPD_10_"

pp_Normal_40SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_10ng_40SPD_1CV.tsv"), sep = "/")
pp_Normal_40SPD_10$indiv <- "Normal_40SPD_10_"

pp_Rapid_20SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Rapid_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Rapid_20SPD_10$indiv <- "Rapid_20SPD_10_"

pp_Normal_20SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Normal_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Normal_20SPD_10$indiv <- "Normal_20SPD_10_"

pp_Enhanced_20SPD_10 <- read.csv2(paste0(ppp_path, "PPP_LIT_Enhanced_DIA_10ng_20SPD_1CV.tsv"), sep = "/")
pp_Enhanced_20SPD_10$indiv <- "Enhanced_20SPD_10_"
```

## Colnames A

Columns are renamed.

```{r}
colnames(pp_Turbo_40SPD_1) <- colnames(pp_Turbo_40SPD_5) <- 
colnames(pp_Turbo_40SPD_10) <-  colnames(pp_Rapid_40SPD_1) <- 
colnames(pp_Rapid_40SPD_5) <- colnames(pp_Rapid_40SPD_10) <-  
colnames(pp_Normal_40SPD_1) <- colnames(pp_Normal_40SPD_5) <- 
colnames(pp_Normal_40SPD_10) <- colnames(pp_Rapid_20SPD_1) <- 
colnames(pp_Rapid_20SPD_5) <- colnames(pp_Rapid_20SPD_10) <-  
colnames(pp_Normal_20SPD_1) <- colnames(pp_Normal_20SPD_5) <-
colnames(pp_Normal_20SPD_10) <-  colnames(pp_Enhanced_20SPD_1) <- colnames(pp_Enhanced_20SPD_5) <- colnames(pp_Enhanced_20SPD_10) <- 
c("Points_per_Peaks", "indiv")
```

## Join A

Data frames containing PPP are combined with the function `rbind()`.

```{r}
ppp <- rbind(pp_Turbo_40SPD_1, pp_Turbo_40SPD_5, pp_Turbo_40SPD_10, 
            pp_Rapid_40SPD_1, pp_Rapid_40SPD_5, pp_Rapid_40SPD_10, 
            pp_Normal_40SPD_1, pp_Normal_40SPD_5, pp_Normal_40SPD_10,
            pp_Rapid_20SPD_1, pp_Rapid_20SPD_5, pp_Rapid_20SPD_10,
            pp_Normal_20SPD_1, pp_Normal_20SPD_5, pp_Normal_20SPD_10, 
            pp_Enhanced_20SPD_1, pp_Enhanced_20SPD_5, pp_Enhanced_20SPD_10)
```

The number of samples per day, the injection time and the scanning mode are added to the data frame and the function `factor()` is used to set the order.

```{r}
ppp$input <- NA
ppp$input[grepl("1_", ppp$indiv)] <- "1 ng"
ppp$input[grepl("5_", ppp$indiv)] <- "5 ng"
ppp$input[grepl("10_", ppp$indiv)] <- "10 ng"
ppp$input <- factor(ppp$input, levels = unique(ppp$input))

ppp$IT <- NA
ppp$IT[grepl("20SPD", ppp$indiv)] <- "20 SPD"
ppp$IT[grepl("40SPD", ppp$indiv)] <- "40 SPD"
ppp$IT <- factor(ppp$IT, levels = c("40 SPD", "20 SPD"))

ppp$method <- NA
ppp$method[grepl("Turbo", ppp$indiv)] <- "Turbo"
ppp$method[grepl("Rapid", ppp$indiv)] <- "Rapid"
ppp$method[grepl("Normal", ppp$indiv)] <- "Normal"
ppp$method[grepl("Enhanced", ppp$indiv)] <- "Enhanced"
ppp$method <- factor(ppp$method, levels = c("Turbo", "Rapid", "Normal", "Enhanced"))
```

## Plot A

PPP distribution from 20 SPD and 40 SPD are plotted separately using violin plots in `ggplot2` and then combined together with patchwork.
The min and max value for each plot are stored in "limit" so both plot can have the same scale while still including every values.

```{r, message=FALSE}
# 40 SPD
palette1 <-c("#C8F5FF", "#75CFFF", "#B3E4FF") 

plot_40SPD <- ppp %>%
  filter(IT == "40 SPD") %>% 
  ggplot(aes(x = input, y = Points_per_Peaks,
             fill = as.factor(indiv)))+
  scale_y_log10()+
  geom_violin(draw_quantiles = 0.5) +
  scale_fill_manual(values = rep(palette1,3)) +
  facet_grid(IT ~ method)+
  geom_hline(yintercept = 6,
             linetype = "dashed") +
  labs(title = "A")+
  theme(legend.position = "none",
        axis.text = element_text(size = 24),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 20,  
                             r = 50,
                             b = 20,
                             l = 10),
        plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.1))
# 20 SPD
palette2 <- c("#00E5E6", "#009999", "#00CCCC")

plot_20SPD <- ppp %>%
  filter(IT == "20 SPD") %>% 
  ggplot(aes(x = input, y = Points_per_Peaks,
             fill = as.factor(indiv)))+
  geom_violin(draw_quantiles = 0.5)+
  scale_y_log10() +
  scale_fill_manual(values = rep(palette2,3)) +
  facet_grid(IT ~ method) +
  geom_hline(yintercept = 6,
             linetype = "dashed") +
  labs(x = "Input",
       y = "Points across a peak") +
  theme(legend.position = "none",
        axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 90, vjust = 0.3, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        plot.margin = margin(t = 15,  
                             r = 50,
                             b = 10,
                             l = 10))

limit <- 10^c(min(c(layer_scales(plot_40SPD)$y$get_limits(), 
                   layer_scales(plot_20SPD)$y$get_limits())),
              max(c(layer_scales(plot_40SPD)$y$get_limits(),
                   layer_scales(plot_20SPD)$y$get_limits())))
```

Plot_40SPD and Plot_20SPD are combined using patchwork to create figure 5a.

```{r, fig.width=16, fig.height=9}
figure5a <- (plot_40SPD + 
    scale_y_log10(limits = limit,
                   breaks = c(3, 6, 10, 30))+
    theme(axis.title = element_blank(),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank()))/
  (plot_20SPD + 
     scale_y_log10(limits = limit,
                   breaks = c(3, 6, 10, 30))+
     theme(axis.title.y = element_text(hjust = -1.8, vjust = 1)))
figure5a
```

# Figure B

Comparison of the number of precursors with a number of points across a peak equal to or greater than 6 on DIA-LIT-based method on Turbo, Rapid, and Normal scanning mode with different input material (1 ng, 5 ng, and 10 ng of tryptic HeLa lysate) on WhisperTM 100 40 SPD and on Rapid, Normal, and Enhanced scanning mode with different input material (1 ng, 5 ng, and 10 ng of tryptic HeLa lysate) on WhisperTM 100 20 SPD.

To create a stacked barplot, the data frame is separated in two different groups. `temp2` includes all peptides with at least six points across the peak. `temp1` all the others. Both are combined in `temp` with `rbind()`.

```{r}
ppp$acc <- ppp$Points_per_Peaks >= 6

temp1 <- ppp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_prec = sum(!is.na(Points_per_Peaks)))

temp2 <- ppp %>% 
  group_by(indiv, IT, input, method) %>% 
  summarise(n_acc = sum(acc))

temp1$Precursors <- "< 6"
temp2$Precursors <- "\U2265 6"

colnames(temp1)[5] <- "n"
colnames(temp2)[5] <- "n"

temp1$n <- temp1$n - temp2$n

temp <- rbind(temp2, temp1)

temp$Precursors <- factor(temp$Precursors, 
                         levels = c("< 6", "\U2265 6"))
```

PPP numbers from 20 SPD and 40 SPD are plotted separately using stacked col plot in `ggplot2` and then combined together with patchwork.
n column contains the number of precursors for all the replicates, this number is divided by 4 obtain the mean.

```{r, fig.width=16, fig.height=9}
id_pr_40SPD <- temp %>% 
  filter(IT == "40 SPD" ) %>% 
  ggplot(aes(x = method, y = n/4, fill = Precursors, group = method)) +
  geom_col() +
  theme_bw() +
  facet_grid(IT ~ input) +
  labs(x = "Scanning mode",
       y = "Precursors number",
       title = "B",
       fill = "Points across a peak")+
  scale_fill_manual(values = c("grey82", "#ff3030"))+
  theme(plot.title = element_text(size = 32, face = "bold",
                                  hjust = -0.095),
        axis.title = element_blank(),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background = element_rect(fill = "#E5E4F7"),
        legend.title = element_text(size = 27, vjust = 1.3),
        legend.text = element_text(size = 22),
        legend.position = "top")

id_pr_20SPD <- temp %>% 
  filter(IT == "20 SPD" ) %>% 
  ggplot(aes(x = method , y = n/4, fill = Precursors, group = method)) +
  geom_col() +
  theme_bw() +
  facet_grid(IT ~ input) +
  labs(x = "Scanning mode",
       y = "Precursors number")+
  scale_fill_manual(values = c("grey82", "#ff3030"))+
  theme(axis.title = element_text(size = 27),
        axis.text = element_text(size = 24),
        axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(size = 27),
        strip.background.x = element_blank(),
        strip.background = element_rect(fill = "#E5E4F7"),
        strip.text.x = element_blank(),
        axis.title.x = element_text(vjust = -1),
        legend.position = "none")

limit <- c(min(c(layer_scales(id_pr_40SPD)$y$get_limits(),
                 layer_scales(id_pr_20SPD)$y$get_limits())),
           max(c(layer_scales(id_pr_40SPD)$y$get_limits(),
                 layer_scales(id_pr_20SPD)$y$get_limits()))+500)
figure5b <-
 (id_pr_40SPD +
    theme(axis.title = element_blank())+
    scale_y_continuous(limits = limit))/
 (id_pr_20SPD +
    theme(axis.title.y = element_text(hjust = -2.15,
                                      vjust = 3.5))+
    scale_y_continuous(limits = limit))

figure5b
```

# Plot A and B

Plot 5A and 5B are combined using patchwork to create figure 5 and save it as pdf.

```{r, fig.width=16, fig.height=19}
figure5 <- wrap_plots(figure5a,figure5b, nrow = 2)
figure5 

cairo_pdf(filename = "Fig. 5 Improvement of the Number of Points Across Chromatographic Peaks.pdf", width = 16.67, height = 18.75,)
figure5 
dev.off()
```

# Session information

```{r, echo = FALSE}
sessionInfo()
```
